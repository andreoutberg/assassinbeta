<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andre-Assassin | Advanced Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* AO Trading Dark Theme with Gold Accents */
            --bg-primary: #0a0e27;
            --bg-secondary: #0f1729;
            --bg-tertiary: #1a1f3a;
            --border-color: #2a3050;
            --text-primary: #e0e0e0;
            --text-secondary: #8892b0;
            --text-muted: #6b7280;

            /* AO Trading Gold Accent */
            --color-accent: #D4AF37;
            --color-accent-hover: #b8941f;
            --color-accent-light: rgba(212, 175, 55, 0.15);
            --color-accent-glow: rgba(212, 175, 55, 0.3);

            /* Status colors */
            --color-success: #00ff88;
            --color-danger: #ff4444;
            --color-warning: #ffd000;
            --color-info: #00d4ff;

            /* Strategy colors - distinct and vibrant */
            --strategy-adx1m: #3b82f6;    /* Blue */
            --strategy-adx5m: #8b5cf6;    /* Purple */
            --strategy-adx15m: #10b981;   /* Green */
            --strategy-adx30m: #f59e0b;   /* Orange */
            --strategy-custom: #ec4899;   /* Pink */
            --strategy-all: #D4AF37;      /* Gold for "ALL" */

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(212, 175, 55, 0.15);
            --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .system-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.green { background: var(--color-success); }
        .status-dot.yellow { background: var(--color-warning); }
        .status-dot.red { background: var(--color-danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .tab {
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--color-accent);
            background: rgba(0, 212, 255, 0.05);
        }

        .tab.active {
            color: var(--color-accent);
            border-bottom-color: var(--color-accent);
        }

        /* Main Container */
        .container {
            padding: 2rem;
            max-width: 1920px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-section:hover {
            box-shadow: var(--shadow-lg);
        }

        .collapsible-header {
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .collapsible-title {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        .collapsible-title h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .collapsible-summary {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .collapsible-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .collapsible-section.open .collapsible-icon {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-section.open .collapsible-content {
            max-height: 10000px;
        }

        .collapsible-body {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: 0.5rem;
        }

        .stat-subtitle {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th {
            text-align: left;
            padding: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(42, 48, 80, 0.5);
        }

        .data-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        /* Make coin/symbol name (first column) prominent on all screen sizes */
        .data-table td:first-child {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--accent);
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge.long {
            background: rgba(0, 255, 136, 0.2);
            color: var(--color-success);
        }

        .badge.short {
            background: rgba(255, 68, 68, 0.2);
            color: var(--color-danger);
        }

        .badge.live {
            background: rgba(0, 212, 255, 0.2);
            color: var(--status-live);
        }

        .badge.paper {
            background: rgba(255, 208, 0, 0.2);
            color: var(--status-paper);
        }

        .badge.baseline {
            background: rgba(139, 92, 246, 0.2);
            color: var(--status-baseline);
        }

        /* Strategy badges */
        .badge.strategy-a {
            background: rgba(59, 130, 246, 0.2);
            color: var(--strategy-a);
        }

        .badge.strategy-b {
            background: rgba(139, 92, 246, 0.2);
            color: var(--strategy-b);
        }

        .badge.strategy-c {
            background: rgba(245, 158, 11, 0.2);
            color: var(--strategy-c);
        }

        .badge.strategy-d {
            background: rgba(16, 185, 129, 0.2);
            color: var(--strategy-d);
        }

        /* P&L Colors */
        .pnl.positive { color: var(--color-success); }
        .pnl.negative { color: var(--color-danger); }

        /* Strategy comparison grid */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .strategy-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .strategy-card.winner {
            border-color: var(--color-success);
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.2);
        }

        .strategy-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .strategy-stats {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top: 3px solid var(--color-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Strategy Filter Tabs */
        .strategy-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .filter-btn {
            padding: 0.625rem 1.25rem;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 590;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            border-color: var(--color-accent);
            background: var(--color-accent-light);
            color: var(--color-accent);
            box-shadow: 0 0 20px var(--color-accent-glow);
        }

        .filter-btn.strategy-all.active {
            border-color: var(--strategy-all);
            color: var(--strategy-all);
        }

        .filter-btn.strategy-adx1m.active {
            border-color: var(--strategy-adx1m);
            color: var(--strategy-adx1m);
        }

        .filter-btn.strategy-adx5m.active {
            border-color: var(--strategy-adx5m);
            color: var(--strategy-adx5m);
        }

        .filter-btn.strategy-adx15m.active {
            border-color: var(--strategy-adx15m);
            color: var(--strategy-adx15m);
        }

        .filter-btn.strategy-adx30m.active {
            border-color: var(--strategy-adx30m);
            color: var(--strategy-adx30m);
        }

        /* MOBILE - Clean & Uniform Design */
        @media (max-width: 768px) {
            /* Reset & Base */
            * { box-sizing: border-box; }
            html, body {
                overflow-x: hidden;
                width: 100%;
                font-size: 14px;
            }

            /* Spacing System: 0.5rem base unit */
            .container {
                padding: 0.5rem;
                max-width: 100vw;
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            }

            /* Header - Compact */
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
                padding: 0.5rem;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .logo {
                font-size: 1rem;
                font-weight: 700;
            }

            .system-status {
                gap: 0.25rem;
                font-size: 0.7rem;
            }

            .status-badge {
                padding: 0.25rem 0.5rem;
                font-size: 0.65rem;
            }

            /* Navigation - Compact Tabs */
            .nav-tabs {
                padding: 0.5rem;
                gap: 0.25rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tab {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
                white-space: nowrap;
                min-height: 36px;
            }

            /* Sections - Uniform Spacing */
            .collapsible-section {
                margin-bottom: 0.5rem;
                border-radius: 6px;
            }

            .collapsible-header {
                padding: 0.75rem;
            }

            .collapsible-title h2 {
                font-size: 0.875rem;
                font-weight: 600;
                margin: 0;
            }

            .collapsible-summary {
                font-size: 0.7rem;
                margin-top: 0.125rem;
            }

            .collapsible-icon {
                font-size: 1.25rem;
            }

            .collapsible-body {
                padding: 0.75rem;
            }

            /* Stat Cards - Clean 2-Column Grid */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem;
                border-radius: 6px;
            }

            .stat-label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 0.25rem;
                color: rgba(255, 255, 255, 0.65);
                font-weight: 600;
            }

            .stat-value {
                font-size: 1.25rem;
                font-weight: 700;
                line-height: 1;
                color: var(--text-primary);
            }

            /* Tables - Simple Horizontal Scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -0.5rem;
                padding: 0 0.5rem;
            }

            .data-table {
                width: 100%;
                font-size: 0.65rem;
                border-collapse: collapse;
                display: block;
            }

            .data-table thead {
                display: none;
            }

            .data-table tbody {
                display: block;
                width: 100%;
            }

            .data-table tr {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                border-radius: 6px;
            }

            .data-table td {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
                padding: 0;
                border: none;
            }

            /* Make coin name (first column) bigger and bold */
            .data-table td:first-child {
                font-size: 0.85rem;
                font-weight: 700;
                color: var(--accent);
            }

            .data-table td strong {
                font-size: 0.6rem;
                text-transform: uppercase;
                color: rgba(0, 212, 255, 0.8);
                letter-spacing: 0.3px;
                font-weight: 700;
            }

            .data-table td span,
            .data-table td {
                font-size: 0.7rem;
                color: var(--text-primary);
                font-weight: 500;
                word-wrap: break-word;
            }

            .data-table tr:hover {
                background: rgba(0, 212, 255, 0.05);
            }

            /* Strategy Grid */
            .strategy-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .strategy-filters {
                padding: 0.5rem;
                gap: 0.25rem;
                flex-wrap: wrap;
            }

            .filter-btn {
                font-size: 0.7rem;
                padding: 0.5rem 0.75rem;
                flex: 1;
                min-width: calc(50% - 0.125rem);
            }

            /* Modals */
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 12px 12px 0 0;
                max-height: 100vh;
            }

            .modal-header {
                padding: 0.75rem;
            }

            .modal-header h2 {
                font-size: 0.95rem;
            }

            .modal-body {
                padding: 0.75rem;
            }

            .modal-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            /* Phase Cards */
            .phase-card {
                margin-bottom: 0.5rem;
            }

            .phase-card-header {
                padding: 0.75rem;
                font-size: 0.75rem;
            }

            .phase-card-body {
                padding: 0.5rem 0.75rem;
            }

            /* Floating Refresh Button */
            .mobile-refresh-btn {
                position: fixed;
                bottom: calc(0.75rem + env(safe-area-inset-bottom));
                right: 0.75rem;
                width: 48px;
                height: 48px;
                border-radius: 50%;
                background: var(--accent);
                color: var(--bg-primary);
                border: none;
                box-shadow: 0 2px 8px rgba(0, 212, 255, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 50;
            }

            .mobile-refresh-btn.refreshing {
                animation: spin 0.6s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Hide desktop elements */
            .desktop-only { display: none !important; }
        }

        /* Print */
        @media print {
            .header, .nav-tabs {
                display: none;
            }
        }

        /* Modal Popup */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-container {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 2px solid var(--color-accent);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(212, 175, 55, 0.05);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 68, 68, 0.2);
            color: var(--color-danger);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-section {
            margin-bottom: 2rem;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-field {
            background: rgba(255, 255, 255, 0.02);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .modal-field-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .modal-field-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-ai-text {
            background: rgba(255, 255, 255, 0.02);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--color-accent);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .modal-list {
            list-style: none;
            padding: 0;
        }

        .modal-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(42, 48, 80, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-list li:last-child {
            border-bottom: none;
        }

        .modal-list-icon {
            font-size: 1rem;
        }

        .modal-trades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .modal-trades-table th {
            text-align: left;
            padding: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .modal-trades-table td {
            padding: 0.5rem;
            border-bottom: 1px solid rgba(42, 48, 80, 0.3);
        }

        .modal-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .clickable-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-row:hover {
            background: rgba(212, 175, 55, 0.1) !important;
            transform: scale(1.01);
        }

        /* Milestone Tracking */
        .milestone-container {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 3px solid rgba(212, 175, 55, 0.3);
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 0.25rem 0;
        }

        .milestone-header:hover {
            color: var(--color-accent);
        }

        .milestone-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .milestone-toggle {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .milestone-content {
            margin-top: 0.5rem;
            display: none;
        }

        .milestone-content.expanded {
            display: block;
        }

        .milestone-section {
            margin-bottom: 0.75rem;
        }

        .milestone-section:last-child {
            margin-bottom: 0;
        }

        .milestone-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.25rem 0;
        }

        .milestone-icon {
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .milestone-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .milestone-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-left: auto;
        }

        .milestone-distance {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-left: auto;
        }

        .milestone-reached {
            color: var(--color-success);
        }

        .milestone-pending {
            color: var(--text-secondary);
        }

        .milestone-tp-badge {
            background: rgba(0, 212, 255, 0.2);
            color: var(--status-live);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.25rem;
        }

        .safety-status {
            padding: 0.5rem;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--color-success);
        }

        .safety-status.warning {
            background: rgba(255, 208, 0, 0.1);
            border-left-color: var(--status-paper);
        }

        .safety-status.danger {
            background: rgba(255, 68, 68, 0.1);
            border-left-color: var(--color-danger);
        }

        .safety-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.15rem 0;
        }

        .safety-icon {
            font-size: 0.85rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: var(--color-success);
        }

        .toast.error {
            border-left-color: var(--color-danger);
        }

        .toast.info {
            border-left-color: var(--color-info);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease;
        }

        /* Modal Dialog for Regeneration */
        .regen-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .regen-modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        .regen-modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .regen-modal-body {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .regen-modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .regen-modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .regen-modal-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .regen-modal-btn.cancel:hover {
            background: var(--border-color);
        }

        .regen-modal-btn.confirm {
            background: linear-gradient(135deg, var(--color-accent), var(--color-info));
            color: white;
        }

        .regen-modal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.5);
        }

        .regen-symbol-select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        /* Simulation Button */
        .btn-simulation {
            padding: 0.375rem 0.75rem;
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-simulation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--color-accent-glow);
        }

        /* Simulation Modal */
        .simulation-chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
        }

        .simulation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .simulation-table th {
            text-align: left;
            padding: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .simulation-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(42, 48, 80, 0.5);
        }

        .simulation-table tr.active-strategy {
            background: rgba(212, 175, 55, 0.15);
            border-left: 3px solid var(--color-accent);
        }

        .simulation-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .strategy-label {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .strategy-a-label { color: var(--strategy-adx1m); }
        .strategy-b-label { color: var(--strategy-adx5m); }
        .strategy-c-label { color: var(--strategy-adx15m); }
        .strategy-d-label { color: var(--strategy-adx30m); }

        /* Info Card Styles */
        .cards-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-accent);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .expand-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .expand-btn:hover {
            background: var(--color-accent-light);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .expand-btn.expanded {
            transform: rotate(180deg);
            background: var(--color-accent-light);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .card-main-stat {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: 1rem;
            line-height: 1;
        }

        .card-sub-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }

        .sub-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .sub-stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .sub-stat-value {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .card-expandable {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .collapsible-row {
            margin-bottom: 2rem;
        }

        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .row-header:hover {
            background: var(--bg-secondary);
        }

        .row-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .row-toggle {
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .row-toggle.expanded {
            transform: rotate(180deg);
        }

        .row-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .row-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-indicator.online {
            color: var(--color-success);
        }

        .status-indicator.warning {
            background: rgba(255, 208, 0, 0.1);
            color: var(--color-warning);
        }

        .status-indicator.error {
            background: rgba(255, 68, 68, 0.1);
            color: var(--color-danger);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">Andre-Assassin Trading System</div>
        <div class="system-status">
            <div class="status-badge">
                <div class="status-dot green" id="status-dot"></div>
                <span id="status-text">System Healthy</span>
            </div>
            <div class="status-badge">
                <span id="last-update">Updated: --</span>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="live-trades">Live Trades</div>
        <div class="tab" data-tab="ai-insights">AI Insights</div>
        <div class="tab" data-tab="learning">Learning Stats</div>
        <div class="tab" data-tab="strategy-analysis">Strategy Analysis</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab 1: Dashboard (Main Overview) -->
        <div id="dashboard" class="tab-content active">
            <!-- Row 1: Core Metrics (Always Visible) -->
            <div class="cards-row">
                <!-- Card 1: Account Summary -->
                <div class="info-card" id="card-account">
                    <div class="card-header">
                        <div class="card-title">Account Summary</div>
                        <button class="expand-btn" onclick="toggleCardExpand('card-account')">↓</button>
                    </div>
                    <div class="card-main-stat" id="account-balance">$--</div>
                    <div class="card-sub-stats">
                        <div class="sub-stat">
                            <div class="sub-stat-label">Net P&L</div>
                            <div class="sub-stat-value pnl" id="net-pnl">$--</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Realized</div>
                            <div class="sub-stat-value pnl" id="realized-pnl">$--</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Unrealized</div>
                            <div class="sub-stat-value pnl" id="current-pnl">$--</div>
                        </div>
                    </div>
                    <div class="card-expandable" id="card-account-expandable" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                            <div>
                                <span style="color: var(--text-secondary);">Total Trades:</span>
                                <span style="color: var(--text-primary); font-weight: 600; margin-left: 0.5rem;" id="account-total-trades">--</span>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Exposure:</span>
                                <span style="color: var(--text-primary); font-weight: 600; margin-left: 0.5rem;" id="total-exposure">$--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Active Trades -->
                <div class="info-card" id="card-trades">
                    <div class="card-header">
                        <div class="card-title">Active Trades</div>
                        <button class="expand-btn" onclick="toggleCardExpand('card-trades')">↓</button>
                    </div>
                    <div class="card-main-stat" id="active-count">--</div>
                    <div class="card-sub-stats">
                        <div class="sub-stat">
                            <div class="sub-stat-label">Live</div>
                            <div class="sub-stat-value" style="color: var(--color-info);" id="live-count">0</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Paper</div>
                            <div class="sub-stat-value" style="color: var(--color-warning);" id="paper-count">0</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Baseline</div>
                            <div class="sub-stat-value" style="color: var(--strategy-adx5m);" id="baseline-count">0</div>
                        </div>
                    </div>
                    <div class="card-expandable" id="card-trades-expandable" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Best Trade:</span>
                                <span style="color: var(--color-success); font-weight: 600;" id="best-trade-value">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Worst Trade:</span>
                                <span style="color: var(--color-danger); font-weight: 600;" id="worst-trade-value">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 3: System Health -->
                <div class="info-card" id="card-health">
                    <div class="card-header">
                        <div class="card-title">System Health</div>
                        <button class="expand-btn" onclick="toggleCardExpand('card-health')">↓</button>
                    </div>
                    <div class="card-main-stat" style="font-size: 1.5rem;">
                        <span class="status-indicator online" id="system-status">
                            <span class="status-dot green"></span>
                            Online
                        </span>
                    </div>
                    <div class="card-sub-stats">
                        <div class="sub-stat">
                            <div class="sub-stat-label">API</div>
                            <div class="sub-stat-value" id="api-status">--</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Database</div>
                            <div class="sub-stat-value" id="db-status">--</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Tracker</div>
                            <div class="sub-stat-value" id="tracker-status">--</div>
                        </div>
                    </div>
                    <div class="card-expandable" id="card-health-expandable" style="display: none;">
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            <div style="margin-bottom: 0.5rem;">
                                <strong style="color: var(--text-primary);">Uptime:</strong> <span id="system-uptime">--</span>
                            </div>
                            <div>
                                <strong style="color: var(--text-primary);">Active Symbols:</strong> <span id="active-symbols">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 4: Portfolio Performance -->
                <div class="info-card" id="card-portfolio">
                    <div class="card-header">
                        <div class="card-title">Portfolio Performance</div>
                        <button class="expand-btn" onclick="toggleCardExpand('card-portfolio')">↓</button>
                    </div>
                    <div class="card-main-stat" id="portfolio-best-return">--</div>
                    <div class="card-sub-stats">
                        <div class="sub-stat">
                            <div class="sub-stat-label">Max Drawdown</div>
                            <div class="sub-stat-value" style="color: var(--color-danger);" id="portfolio-max-drawdown">--</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-stat-label">Best Strategy</div>
                            <div class="sub-stat-value" id="portfolio-best-strategy">--</div>
                        </div>
                    </div>
                    <div class="card-expandable" id="card-portfolio-expandable" style="display: none;">
                        <div style="font-size: 0.875rem;">
                            <div style="margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                                <strong style="color: var(--text-primary);">Strategy Comparison:</strong>
                            </div>
                            <div id="portfolio-strategy-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Top Performers (Collapsible) -->
            <div class="collapsible-row">
                <div class="row-header" onclick="toggleRow('row-performers')">
                    <div class="row-title">Top Performers</div>
                    <div class="row-toggle" id="row-performers-toggle">▼</div>
                </div>
                <div class="row-content collapsed" id="row-performers-content">
                    <div class="cards-row">
                        <!-- Card 5: Best Strategy -->
                        <div class="info-card" id="card-best-strategy">
                            <div class="card-header">
                                <div class="card-title">Best Strategy</div>
                                <button class="expand-btn" onclick="toggleCardExpand('card-best-strategy')">↓</button>
                            </div>
                            <div class="card-main-stat" id="best-strategy-name">--</div>
                            <div class="card-sub-stats">
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Win Rate</div>
                                    <div class="sub-stat-value" id="best-strategy-wr">--</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Total P&L</div>
                                    <div class="sub-stat-value pnl" id="best-strategy-pnl">--</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Trades</div>
                                    <div class="sub-stat-value" id="best-strategy-trades">--</div>
                                </div>
                            </div>
                            <div class="card-expandable" id="card-best-strategy-expandable" style="display: none;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    <div><strong style="color: var(--text-primary);">Avg P&L/Trade:</strong> <span id="best-strategy-avg">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 6: Best Asset -->
                        <div class="info-card" id="card-best-asset">
                            <div class="card-header">
                                <div class="card-title">Best Asset</div>
                                <button class="expand-btn" onclick="toggleCardExpand('card-best-asset')">↓</button>
                            </div>
                            <div class="card-main-stat" id="best-asset-name">--</div>
                            <div class="card-sub-stats">
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Total P&L</div>
                                    <div class="sub-stat-value pnl" id="best-asset-pnl">--</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Win Rate</div>
                                    <div class="sub-stat-value" id="best-asset-wr">--</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Trades</div>
                                    <div class="sub-stat-value" id="best-asset-trades">--</div>
                                </div>
                            </div>
                            <div class="card-expandable" id="card-best-asset-expandable" style="display: none;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    <div><strong style="color: var(--text-primary);">Direction:</strong> <span id="best-asset-direction">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Card 7: Best Source -->
                        <div class="info-card" id="card-best-source">
                            <div class="card-header">
                                <div class="card-title">Best Source</div>
                                <button class="expand-btn" onclick="toggleCardExpand('card-best-source')">↓</button>
                            </div>
                            <div class="card-main-stat" id="best-source-name">--</div>
                            <div class="card-sub-stats">
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Total P&L</div>
                                    <div class="sub-stat-value pnl" id="best-source-pnl">--</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Win Rate</div>
                                    <div class="sub-stat-value" id="best-source-wr">--</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">Signals</div>
                                    <div class="sub-stat-value" id="best-source-signals">--</div>
                                </div>
                            </div>
                            <div class="card-expandable" id="card-best-source-expandable" style="display: none;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    <div><strong style="color: var(--text-primary);">Avg P&L/Signal:</strong> <span id="best-source-avg">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 3: Breakeven A/B Test (Collapsible) -->
            <div class="collapsible-row">
                <div class="row-header" onclick="toggleRow('row-breakeven')">
                    <div class="row-title">Breakeven A/B Test Results</div>
                    <div class="row-toggle" id="row-breakeven-toggle">▼</div>
                </div>
                <div class="row-content collapsed" id="row-breakeven-content">
                    <div class="cards-row" style="grid-template-columns: 1fr;">
                        <!-- Card 8: Breakeven Test -->
                        <div class="info-card" id="card-breakeven">
                            <div class="card-header">
                                <div class="card-title">Breakeven Strategy Test</div>
                                <button class="expand-btn" onclick="toggleCardExpand('card-breakeven')">↓</button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">With Breakeven</div>
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--color-success);" id="breakeven-with-pnl">--</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                        Win Rate: <span style="color: var(--text-primary); font-weight: 600;" id="breakeven-with-wr">--</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Without Breakeven</div>
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--color-danger);" id="breakeven-without-pnl">--</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                        Win Rate: <span style="color: var(--text-primary); font-weight: 600;" id="breakeven-without-wr">--</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-expandable" id="card-breakeven-expandable" style="display: none;">
                                <div style="font-size: 0.875rem;">
                                    <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                                        <div style="margin-bottom: 0.75rem;"><strong style="color: var(--text-primary);">Difference:</strong> <span class="pnl" id="breakeven-difference">--</span></div>
                                        <div style="margin-bottom: 0.75rem;"><strong style="color: var(--text-primary);">Sample Size:</strong> <span style="color: var(--text-secondary);" id="breakeven-sample-size">--</span></div>
                                        <div><strong style="color: var(--text-primary);">Conclusion:</strong> <span style="color: var(--text-secondary);" id="breakeven-conclusion">--</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Sections (Existing collapsible sections moved to bottom) -->
            <div style="margin-top: 3rem;">
                <h2 style="color: var(--text-secondary); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem;">Detailed Analytics</h2>

                <!-- 3-Phase Strategy System Overview -->
                <div class="collapsible-section" id="phase-system-section">
                    <div class="collapsible-header" onclick="toggleSection('phase-system-section')">
                        <div class="collapsible-title">
                            <h2>3-Phase Strategy System</h2>
                            <div class="collapsible-summary">Phase status and strategy performance across all symbols</div>
                        </div>
                        <span class="collapsible-icon">▶</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body">
                            <!-- Phase System Stats -->
                            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 2rem;">
                                <div class="stat-card">
                                    <div class="stat-label">Phase I (Data Collection)</div>
                                    <div class="stat-value" id="phase-i-count">--</div>
                                    <div class="stat-subtitle">Collecting baseline data</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Phase II (Optimization)</div>
                                    <div class="stat-value" id="phase-ii-count">--</div>
                                    <div class="stat-subtitle">Paper trading strategies</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Phase III (Live)</div>
                                    <div class="stat-value" id="phase-iii-count">--</div>
                                    <div class="stat-subtitle">Live trading</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Best Strategy</div>
                                    <div class="stat-value" id="best-strategy-name-phase">--</div>
                                    <div class="stat-subtitle">Highest scoring</div>
                                </div>
                            </div>

                            <!-- Phase Status Table -->
                            <div style="margin-bottom: 2rem;">
                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Phase Status by Symbol</h3>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Direction</th>
                                            <th>Webhook Source</th>
                                            <th>Phase</th>
                                            <th>Baseline Progress</th>
                                            <th>Best Strategy</th>
                                            <th>Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="phase-status-table-body">
                                        <tr>
                                            <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                                Loading phase data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Regeneration Progress Indicator -->
                            <div style="margin-bottom: 2rem;">
                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Strategy Regeneration Status</h3>
                                <div class="stat-card" style="padding: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2rem; align-items: center;">
                                        <!-- Progress Section -->
                                        <div>
                                            <div style="margin-bottom: 0.5rem;">
                                                <span style="font-size: 0.875rem; color: var(--text-secondary);">Next Regeneration</span>
                                                <span style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 0.5rem;" id="regen-progress-text">-- / 20 trades</span>
                                            </div>
                                            <div class="progress" style="height: 24px; background: var(--bg-tertiary); border-radius: 12px; overflow: hidden; position: relative;">
                                                <div class="progress-bar" id="regen-progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, var(--color-info), var(--color-accent)); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: white;">
                                                    0%
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Last Regeneration Section -->
                                        <div style="text-align: center; padding: 0 1rem; border-left: 1px solid var(--border-color);">
                                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Last Regeneration</div>
                                            <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary);" id="last-regen-time">--</div>
                                        </div>

                                        <!-- Manual Trigger Section -->
                                        <div style="text-align: center; padding: 0 1rem; border-left: 1px solid var(--border-color);">
                                            <button
                                                id="manual-regen-btn"
                                                onclick="showRegenerationDialog()"
                                                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--color-accent), var(--color-info)); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);"
                                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 212, 255, 0.5)';"
                                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 212, 255, 0.3)';"
                                            >
                                                Force Regenerate
                                            </button>
                                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Manual override</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Strategy Performance Comparison -->
                            <div style="margin-bottom: 2rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3 style="color: var(--text-primary); margin: 0;">Strategy Performance (A/B/C/D)</h3>
                                    <select id="strategy-symbol-filter" onchange="updateStrategyPerformance()" style="padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer;">
                                        <option value="">Select symbol...</option>
                                    </select>
                                </div>

                                <!-- Strategy Cards -->
                                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;" id="strategy-cards-container">
                                    <!-- Strategy A Card -->
                                    <div class="stat-card" id="strategy-a-card" style="border-left: 4px solid #3b82f6;">
                                        <div class="stat-label" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Strategy A (Conservative)</span>
                                            <input type="checkbox" id="strategy-a-toggle" checked onchange="toggleStrategyOverlay('A')">
                                        </div>
                                        <div class="stat-value" id="strategy-a-rr">--</div>
                                        <div class="stat-subtitle">
                                            WR: <span id="strategy-a-wr">--</span> |
                                            Trades: <span id="strategy-a-trades">--</span><br>
                                            <span id="strategy-a-eligible" style="font-weight: 600;">⏳ Not eligible</span>
                                        </div>
                                    </div>

                                    <!-- Strategy B Card -->
                                    <div class="stat-card" id="strategy-b-card" style="border-left: 4px solid #8b5cf6;">
                                        <div class="stat-label" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Strategy B (Balanced)</span>
                                            <input type="checkbox" id="strategy-b-toggle" checked onchange="toggleStrategyOverlay('B')">
                                        </div>
                                        <div class="stat-value" id="strategy-b-rr">--</div>
                                        <div class="stat-subtitle">
                                            WR: <span id="strategy-b-wr">--</span> |
                                            Trades: <span id="strategy-b-trades">--</span><br>
                                            <span id="strategy-b-eligible" style="font-weight: 600;">⏳ Not eligible</span>
                                        </div>
                                    </div>

                                    <!-- Strategy C Card -->
                                    <div class="stat-card" id="strategy-c-card" style="border-left: 4px solid #10b981;">
                                        <div class="stat-label" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Strategy C (Aggressive)</span>
                                            <input type="checkbox" id="strategy-c-toggle" checked onchange="toggleStrategyOverlay('C')">
                                        </div>
                                        <div class="stat-value" id="strategy-c-rr">--</div>
                                        <div class="stat-subtitle">
                                            WR: <span id="strategy-c-wr">--</span> |
                                            Trades: <span id="strategy-c-trades">--</span><br>
                                            <span id="strategy-c-eligible" style="font-weight: 600;">⏳ Not eligible</span>
                                        </div>
                                    </div>

                                    <!-- Strategy D Card -->
                                    <div class="stat-card" id="strategy-d-card" style="border-left: 4px solid #f59e0b;">
                                        <div class="stat-label" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Strategy D (Adaptive)</span>
                                            <input type="checkbox" id="strategy-d-toggle" checked onchange="toggleStrategyOverlay('D')">
                                        </div>
                                        <div class="stat-value" id="strategy-d-rr">--</div>
                                        <div class="stat-subtitle">
                                            WR: <span id="strategy-d-wr">--</span> |
                                            Trades: <span id="strategy-d-trades">--</span><br>
                                            <span id="strategy-d-eligible" style="font-weight: 600;">⏳ Not eligible</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Strategy Comparison Chart -->
                                <div class="chart-container" style="height: 400px;">
                                    <canvas id="strategy-comparison-chart"></canvas>
                                </div>
                            </div>

                            <!-- Current Strategy Parameters -->
                            <div id="current-strategy-params" style="display: none; margin-top: 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 12px; border-left: 4px solid var(--color-accent);">
                                <h4 style="margin-bottom: 1rem; color: var(--color-accent);">Current Strategy Parameters</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">TP1</div>
                                        <div style="font-size: 1.25rem; font-weight: 600;" id="current-tp1">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">TP2</div>
                                        <div style="font-size: 1.25rem; font-weight: 600;" id="current-tp2">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">TP3</div>
                                        <div style="font-size: 1.25rem; font-weight: 600;" id="current-tp3">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Stop Loss</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--color-danger);" id="current-sl">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Trailing Stop</div>
                                        <div style="font-size: 1.25rem; font-weight: 600;" id="current-trailing">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Trades by Symbol -->
                <div class="collapsible-section" id="symbols-section">
                    <div class="collapsible-header" onclick="toggleSection('symbols-section')">
                        <div class="collapsible-title">
                            <h2>Active Trades by Symbol</h2>
                            <div class="collapsible-summary" id="symbols-summary">
                                Loading symbol breakdown...
                            </div>
                        </div>
                        <span class="collapsible-icon">▶</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body" id="symbols-content">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading symbols...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Signals -->
                <div class="collapsible-section" id="recent-section">
                    <div class="collapsible-header" onclick="toggleSection('recent-section')">
                        <div class="collapsible-title">
                            <h2>Recent Signals</h2>
                            <div class="collapsible-summary" id="recent-summary">
                                Last 10 webhook signals
                            </div>
                        </div>
                        <span class="collapsible-icon">▶</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body" id="recent-content">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading recent signals...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Tab 3: Live Trades -->
        <div id="live-trades" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">WebSocket Status</div>
                    <div class="stat-value" id="ws-status">--</div>
                    <div class="stat-subtitle">Real-time price updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Connections</div>
                    <div class="stat-value" id="ws-connections">--</div>
                    <div class="stat-subtitle">Multiplexed streams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Update Frequency</div>
                    <div class="stat-value">~1s</div>
                    <div class="stat-subtitle">Live price streaming</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last Event</div>
                    <div class="stat-value" id="last-event">--</div>
                    <div class="stat-subtitle" id="last-event-type">Waiting for updates...</div>
                </div>
            </div>

            <!-- Strategy Filter Tabs (Dynamic) -->
            <div class="strategy-filters" id="strategy-filters">
                <!-- Buttons will be dynamically populated on page load -->
                <button class="filter-btn strategy-all active" onclick="filterByStrategy('all')">ALL</button>
            </div>

            <!-- Status and Time Period Filters -->
            <div class="trade-filters" style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 600; color: #6b7280;">Status:</label>
                    <button class="filter-btn status-filter active" data-status="active" onclick="filterByStatus('active')">Active</button>
                    <button class="filter-btn status-filter" data-status="completed" onclick="filterByStatus('completed')">Closed</button>
                    <button class="filter-btn status-filter" data-status="all" onclick="filterByStatus('all')">All</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 600; color: #6b7280;">Period:</label>
                    <button class="filter-btn period-filter" data-period="today" onclick="filterByPeriod('today')">Today</button>
                    <button class="filter-btn period-filter" data-period="week" onclick="filterByPeriod('week')">Week</button>
                    <button class="filter-btn period-filter" data-period="month" onclick="filterByPeriod('month')">Month</button>
                    <button class="filter-btn period-filter active" data-period="all" onclick="filterByPeriod('all')">All Time</button>
                </div>
            </div>

            <div class="collapsible-section" id="live-trades-section">
                <div class="collapsible-header" onclick="toggleSection('live-trades-section')">
                    <div class="collapsible-title">
                        <h2>Trading Activity</h2>
                        <div class="collapsible-summary" id="live-trades-summary">Real-time price monitoring and P&L tracking</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="live-trades-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Connecting to real-time feed...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: AI Insights -->
        <div id="ai-insights" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">AI Evaluations</div>
                    <div class="stat-value" id="ai-eval-count">--</div>
                    <div class="stat-subtitle">Phase 1: Data Collection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Quality Score</div>
                    <div class="stat-value" id="ai-avg-score">--</div>
                    <div class="stat-subtitle">Out of 10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Confidence</div>
                    <div class="stat-value" id="ai-avg-confidence">--</div>
                    <div class="stat-subtitle">AI certainty level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Red Flags</div>
                    <div class="stat-value" id="ai-red-flags">--</div>
                    <div class="stat-subtitle">Warnings detected</div>
                </div>
            </div>

            <div class="collapsible-section" id="ai-quality-section">
                <div class="collapsible-header" onclick="toggleSection('ai-quality-section')">
                    <div class="collapsible-title">
                        <h2>Quality Score Distribution</h2>
                        <div class="collapsible-summary">AI-evaluated setup quality (Phase 1)</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="ai-quality-content">
                        <div class="chart-container">
                            <canvas id="ai-quality-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section" id="ai-setup-types-section">
                <div class="collapsible-header" onclick="toggleSection('ai-setup-types-section')">
                    <div class="collapsible-title">
                        <h2>Setup Type Breakdown</h2>
                        <div class="collapsible-summary">Breakout, scalp, reversal analysis</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="ai-setup-types-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading setup type analysis...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section" id="ai-flags-section">
                <div class="collapsible-header" onclick="toggleSection('ai-flags-section')">
                    <div class="collapsible-title">
                        <h2>Red Flags vs Green Lights</h2>
                        <div class="collapsible-summary">AI divergence and confluence analysis</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="ai-flags-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading flag analysis...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: Learning Statistics -->
        <div id="learning" class="tab-content">
            <div class="collapsible-section" id="learned-levels-section">
                <div class="collapsible-header" onclick="toggleSection('learned-levels-section')">
                    <div class="collapsible-title">
                        <h2>Per-Symbol Learned TP/SL Levels</h2>
                        <div class="collapsible-summary" id="learned-summary">Loading learned parameters...</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="learned-levels-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading learned statistics...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section" id="rr-section">
                <div class="collapsible-header" onclick="toggleSection('rr-section')">
                    <div class="collapsible-title">
                        <h2>Risk/Reward Ratios Over Time</h2>
                        <div class="collapsible-summary">Tracking R/R evolution and circuit breakers</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="rr-content">
                        <div class="chart-container">
                            <canvas id="rr-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section" id="baseline-section">
                <div class="collapsible-header" onclick="toggleSection('baseline-section')">
                    <div class="collapsible-title">
                        <h2>Baseline Data Collection Progress</h2>
                        <div class="collapsible-summary">First 10 trades per direction per symbol</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="baseline-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading baseline progress...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section" id="circuit-breaker-section">
                <div class="collapsible-header" onclick="toggleSection('circuit-breaker-section')">
                    <div class="collapsible-title">
                        <h2>Circuit Breaker Status</h2>
                        <div class="collapsible-summary">Live vs Paper trading per asset</div>
                    </div>
                    <span class="collapsible-icon">▶</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body" id="circuit-breaker-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading circuit breaker status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Tab 6: Strategy Analysis -->
        <div id="strategy-analysis" class="tab-content">
            <div class="section-header">
                <h2>Strategy Performance Comparison</h2>
                <div class="last-updated" id="strategy-last-updated">Loading...</div>
            </div>

            <!-- Top Performance Cards -->
            <div class="stats-grid" id="strategy-cards-grid">
                <div class="stat-card">
                    <div class="stat-label">Loading...</div>
                    <div class="stat-value">--</div>
                </div>
            </div>

            <!-- Recent Trades with Strategy Comparison -->
            <div class="table-section">
                <h3>Recent Completed Trades - Strategy Comparison</h3>
                <div id="strategy-trades-list">
                    <p>Loading recent trades...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // Global State
        // =====================================================================
        let charts = {};
        let refreshInterval = null;
        let collapsedSections = {};

        // =====================================================================
        // Initialization
        // =====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard initializing...');

            // Initialize sections - restore from localStorage or use defaults
            try {
                // Try to load saved state from localStorage
                const savedState = localStorage.getItem('collapsedSections');
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        Object.assign(collapsedSections, parsed);
                        console.log('Restored section state from localStorage');
                    } catch (parseError) {
                        console.warn('Failed to parse saved state, using defaults:', parseError);
                    }
                }

                // Apply state to sections (use defaults if no saved state)
                document.querySelectorAll('.collapsible-section').forEach(section => {
                    if (section.id) {
                        // Set defaults for sections not in saved state
                        if (collapsedSections[section.id] === undefined) {
                            // Default: Strategy Analytics and Live Trades are open
                            if (section.id === 'strategy-analytics-section' || section.id === 'live-trades-section') {
                                collapsedSections[section.id] = false;  // false means open
                            } else {
                                collapsedSections[section.id] = true;  // true means collapsed
                            }
                        }

                        // Apply the state
                        if (collapsedSections[section.id]) {
                            section.classList.remove('open');  // Collapsed
                        } else {
                            section.classList.add('open');  // Open
                        }
                    }
                });
                console.log('Sections initialized - state restored/applied');
            } catch (error) {
                console.warn('Error initializing collapsed sections:', error);
            }

            // Verify Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js failed to load');
            } else {
                console.log('Chart.js loaded successfully');
            }

            try {
                setupTabSwitching();
                restoreCollapsedState();
                loadStrategyFilters(); // Load dynamic strategy filter buttons
                populateTPSLFilters(); // Populate TP/SL analysis filters
                loadDashboard();
                startAutoRefresh();
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error during dashboard initialization:', error);
            }
        });

        // =====================================================================
        // Tab Switching
        // =====================================================================
        function setupTabSwitching() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            // Load tab-specific data
            loadTabData(tabName);
        }

        // =====================================================================
        // Strategy Filter
        // =====================================================================
        let currentStrategyFilter = 'all';
        let currentStatusFilter = 'active';
        let currentPeriodFilter = 'all';

        function filterByStrategy(strategy) {
            currentStrategyFilter = strategy;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload both live activity and analytics with the selected filter
            loadLiveTrades();
            loadStrategyAnalytics(strategy);  // Update analytics section
        }

        function filterByStatus(status) {
            currentStatusFilter = status;

            // Update button states
            document.querySelectorAll('.status-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload trades with new status filter
            loadLiveTrades();
        }

        function filterByPeriod(period) {
            currentPeriodFilter = period;

            // Update button states
            document.querySelectorAll('.period-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload trades with new period filter
            loadLiveTrades();
        }

        // Load strategies dynamically from API and populate filter buttons
        async function loadStrategyFilters() {
            try {
                const response = await fetch('/api/strategies');
                if (!response.ok) {
                    console.error('Failed to load strategies:', response.status);
                    return;
                }

                const data = await response.json();
                const container = document.getElementById('strategy-filters');

                if (!container) {
                    console.error('Strategy filters container not found');
                    return;
                }

                // Keep the ALL button (already in HTML)
                // Clear any other existing buttons except ALL
                const allButton = container.querySelector('.strategy-all');
                container.innerHTML = '';
                if (allButton) {
                    container.appendChild(allButton);
                }

                // Add buttons for each unique webhook_source
                if (data.strategies && data.strategies.length > 0) {
                    data.strategies.forEach(strategy => {
                        const button = document.createElement('button');
                        button.className = 'filter-btn';
                        button.textContent = strategy.name;
                        button.onclick = () => filterByStrategy(strategy.name);

                        // Add count badge if there are active trades
                        if (strategy.active_trades > 0) {
                            const badge = document.createElement('span');
                            badge.style.cssText = 'margin-left: 0.5rem; padding: 0.125rem 0.375rem; background: rgba(0, 212, 255, 0.2); border-radius: 4px; font-size: 0.75rem;';
                            badge.textContent = strategy.active_trades;
                            button.appendChild(badge);
                        }

                        container.appendChild(button);
                    });

                    console.log(`Loaded ${data.strategies.length} strategy filters`);
                } else {
                    console.log('No strategies found, using default ALL filter only');
                }
            } catch (error) {
                console.error('Error loading strategy filters:', error);
            }
        }

        // =====================================================================
        // Collapsible Sections
        // =====================================================================
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.warn(`Section ${sectionId} not found`);
                return;
            }

            section.classList.toggle('open');

            // Save state to localStorage
            try {
                collapsedSections[sectionId] = !section.classList.contains('open');
                localStorage.setItem('collapsedSections', JSON.stringify(collapsedSections));
            } catch (error) {
                console.warn('Error saving collapsed state to localStorage:', error);
            }
        }

        // Toggle individual card expansion
        function toggleCardExpand(cardId) {
            const expandable = document.getElementById(`${cardId}-expandable`);
            const btn = document.querySelector(`#${cardId} .expand-btn`);

            if (!expandable || !btn) {
                console.warn(`Card elements not found for ${cardId}`);
                return;
            }

            if (expandable.style.display === 'none') {
                expandable.style.display = 'block';
                btn.classList.add('expanded');
            } else {
                expandable.style.display = 'none';
                btn.classList.remove('expanded');
            }
        }

        // Toggle collapsible row
        function toggleRow(rowId) {
            const content = document.getElementById(`${rowId}-content`);
            const toggle = document.getElementById(`${rowId}-toggle`);

            if (!content || !toggle) {
                console.warn(`Row elements not found for ${rowId}`);
                return;
            }

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                toggle.classList.add('expanded');
            } else {
                content.classList.add('collapsed');
                content.style.maxHeight = '0';
                toggle.classList.remove('expanded');
            }
        }

        function restoreCollapsedState() {
            Object.keys(collapsedSections).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    if (collapsedSections[sectionId]) {
                        section.classList.remove('open');
                    } else {
                        section.classList.add('open');
                    }
                }
            });
        }

        // =====================================================================
        // Data Loading
        // =====================================================================
        async function loadDashboard(skipAnalytics = false) {
            try {
                // Load all dashboard data in parallel
                const loadTasks = [
                    loadStrategyFilters(),  // Load strategy filter buttons (used by both dashboard and analytics)
                    loadSystemOverview(),
                    loadPhaseSystemData(),  // Load 3-phase strategy system data
                    loadStrategiesPerformance(),
                    loadSymbolsBreakdown(),
                    loadRecentSignals(),
                    loadPortfolioPerformance(),  // Load portfolio simulation data
                    loadTopPerformers()  // Load top performers data
                ];

                // Only load analytics on initial load, not during auto-refresh (prevents chart flickering)
                if (!skipAnalytics) {
                    loadTasks.push(loadStrategyAnalytics('all'));
                }

                await Promise.allSettled(loadTasks).then(results => {
                    results.forEach((result, index) => {
                        if (result.status === 'rejected') {
                            const sections = ['Strategy Filters', 'System Overview', 'Phase System', 'Strategies', 'Symbols', 'Recent Signals', 'Portfolio Performance', 'Top Performers', 'Analytics Data'];
                            console.error(`Failed to load ${sections[index]}:`, result.reason);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadTabData(tabName, skipAnalytics = false) {
            switch(tabName) {
                case 'dashboard':
                    // Pass skipAnalytics to prevent analytics chart from reloading every 5 seconds
                    await loadDashboard(skipAnalytics);
                    break;
                case 'analytics':
                    // Skip analytics auto-refresh to prevent chart flickering
                    // Analytics data is historical and doesn't need constant updates
                    if (!skipAnalytics) {
                        await loadAnalytics();
                    }
                    break;
                case 'live-trades':
                    await loadLiveTrades();
                    break;
                case 'ai-insights':
                    await loadAIInsights();
                    break;
                case 'learning':
                    await loadLearningStats();
                    break;
                case 'strategy-analysis':
                    await loadStrategyAnalysis();
                    break;
            }
        }

        // TP/SL Hit Rate Analysis
        let tpslChart = null;

        async function loadTPSLAnalysis() {
            const symbol = document.getElementById('tpsl-symbol-filter').value;
            const direction = document.getElementById('tpsl-direction-filter').value;
            
            // Show loading state
            document.getElementById('tpsl-loading').style.display = 'block';
            document.getElementById('tpsl-loading').innerHTML = '<p>Analyzing historical trades...</p>';
            document.getElementById('tpsl-stats').style.display = 'none';
            document.getElementById('tpsl-insight').style.display = 'none';
            
            try {
                // Build query params
                const params = new URLSearchParams();
                if (symbol) params.append('symbol', symbol);
                if (direction) params.append('direction', direction);
                
                // Fetch data
                const response = await fetch(`/api/strategies/tp-sl-analysis?${params}`);
                const data = await response.json();
                
                // Check for error
                if (data.error) {
                    document.getElementById('tpsl-loading').innerHTML = `<p style="color: var(--color-danger);">${data.error}</p>`;
                    return;
                }
                
                // Hide loading, show stats
                document.getElementById('tpsl-loading').style.display = 'none';
                document.getElementById('tpsl-stats').style.display = 'block';
                document.getElementById('tpsl-insight').style.display = 'block';
                
                // Update stats cards
                document.getElementById('tpsl-trades-count').textContent = data.trades_analyzed;
                document.getElementById('tpsl-optimal-tp').textContent = data.optimal_levels.recommended_tp + '%';
                document.getElementById('tpsl-tp-hit-rate').textContent = `${data.optimal_levels.tp_hit_rate}% hit rate`;
                document.getElementById('tpsl-optimal-sl').textContent = '-' + data.optimal_levels.recommended_sl + '%';
                document.getElementById('tpsl-sl-hit-rate').textContent = `${data.optimal_levels.sl_hit_rate}% hit rate`;
                document.getElementById('tpsl-theoretical-rr').textContent = data.optimal_levels.theoretical_rr;
                
                // Update insight text
                const insightText = `
                    Based on ${data.trades_analyzed} historical trades${symbol ? ' for ' + symbol : ''}${direction ? ' ' + direction : ''}:
                    <br><br>
                    • TP at ${data.optimal_levels.recommended_tp}% hits ${data.optimal_levels.tp_hit_rate}% of trades (excellent!)
                    <br>
                    • SL at -${data.optimal_levels.recommended_sl}% only hits ${data.optimal_levels.sl_hit_rate}% of trades (good protection)
                    <br>
                    • Risk/Reward ratio of ${data.optimal_levels.theoretical_rr} means you win ${data.optimal_levels.theoretical_rr}× what you lose
                    <br><br>
                    This analysis helps you understand which TP/SL levels are realistic based on actual market behavior.
                `;
                document.getElementById('tpsl-insight-text').innerHTML = insightText;
                
                // Render chart
                renderTPSLChart(data.chart_data);
                
            } catch (error) {
                console.error('Error loading TP/SL analysis:', error);
                document.getElementById('tpsl-loading').innerHTML = `<p style="color: var(--color-danger);">Error loading analysis: ${error.message}</p>`;
            }
        }

        function renderTPSLChart(chartData) {
            const ctx = document.getElementById('tpsl-chart').getContext('2d');
            
            // Destroy existing chart if exists
            if (tpslChart) {
                tpslChart.destroy();
            }
            
            tpslChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.tp_levels,
                    datasets: [
                        {
                            label: 'TP Hit Rate (%)',
                            data: chartData.tp_hit_rates,
                            borderColor: 'rgba(0, 255, 136, 1)',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'SL Hit Rate (%)',
                            data: chartData.sl_hit_rates,
                            borderColor: 'rgba(255, 68, 68, 1)',
                            backgroundColor: 'rgba(255, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: 'rgba(255, 255, 255, 0.9)',
                            bodyColor: 'rgba(255, 255, 255, 0.8)',
                            borderColor: 'rgba(0, 212, 255, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'TP/SL Level (%)',
                                color: 'rgba(255, 255, 255, 0.8)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Hit Rate (%)',
                                color: 'rgba(255, 255, 255, 0.8)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Populate symbol filter on page load
        async function populateTPSLFilters() {
            try {
                const response = await fetch('/api/strategies/all-phases');
                const data = await response.json();
                
                const symbolFilter = document.getElementById('tpsl-symbol-filter');
                const symbols = new Set();
                
                // Collect unique symbols from all phases
                if (data.summaries) {
                    data.summaries.forEach(asset => symbols.add(asset.symbol));
                }
                
                // Add options
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    symbolFilter.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error populating TP/SL filters:', error);
            }
        }

        async function loadSystemOverview() {
            try {
                // Use live-activity endpoint which includes summary with baseline exclusion
                const response = await fetch('/api/trades/live-activity');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                const trades = data.trades || [];
                const summary = data.summary || {};

                // Update stats with safety checks
                const activeCount = document.getElementById('active-count');
                const liveCount = document.getElementById('live-count');
                const paperCount = document.getElementById('paper-count');
                const baselineCountEl = document.getElementById('baseline-count');
                const totalExposureEl = document.getElementById('total-exposure');
                const pnlElement = document.getElementById('current-pnl');
                const pnlPctEl = document.getElementById('current-pnl-pct');
                const symbolsEl = document.getElementById('active-symbols');

                // Use total_count from API (real count, not paginated)
                if (activeCount) activeCount.textContent = data.total_count || trades.length;
                if (liveCount) liveCount.textContent = summary.live_trades || 0;
                if (paperCount) paperCount.textContent = summary.paper_trades || 0;

                // Show baseline vs strategy breakdown
                const baselineCount = summary.baseline_trades || 0;
                const strategyCount = summary.strategy_trades || 0;
                if (baselineCountEl) baselineCountEl.textContent = baselineCount;

                // Calculate exposure (includes both baseline and strategy)
                const totalExposure = summary.total_exposure_usd || 0;
                if (totalExposureEl) totalExposureEl.textContent = '$' + totalExposure.toFixed(2);

                // USE P&L FROM API SUMMARY (excludes baseline trades - data collection only)
                const totalPnl = summary.total_pnl_usd || 0;
                if (pnlElement) {
                    pnlElement.textContent = (totalPnl >= 0 ? '+' : '-') + '$' + Math.abs(totalPnl).toFixed(2);
                    pnlElement.className = 'stat-value pnl ' + (totalPnl >= 0 ? 'positive' : 'negative');
                }

                // Calculate P&L as % of account balance ($100k)
                const accountBalance = 100000;
                const accountPnlPct = (totalPnl / accountBalance) * 100;
                if (pnlPctEl) {
                    // Add note that baseline trades are excluded
                    const note = strategyCount > 0 ? ` (${strategyCount} strategy trades)` : ' (baseline only - no P&L yet)';
                    pnlPctEl.textContent = `${accountPnlPct >= 0 ? '+' : ''}${accountPnlPct.toFixed(4)}% of account${note}`;
                }

                // Active symbols
                const uniqueSymbols = [...new Set(trades.map(t => t.symbol))];
                if (symbolsEl) symbolsEl.textContent = uniqueSymbols.length;

                // Update account balance and net P&L
                await updateAccountBalance();

            } catch (error) {
                console.error('Error loading system overview:', error);
                // Show user-friendly error state
                const activeCount = document.getElementById('active-count');
                if (activeCount) activeCount.textContent = 'Error';
            }
        }

        async function updateAccountBalance() {
            try {
                const response = await fetch('/api/account/balance');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                // Update Account Balance (starting + realized)
                const accountBalanceEl = document.getElementById('account-balance');
                const accountBalanceSubtitleEl = document.getElementById('account-balance-subtitle');
                if (accountBalanceEl && data.account_balance !== undefined) {
                    accountBalanceEl.textContent = data.account_balance.toLocaleString('en-US', {style: 'currency', currency: 'USD'});
                    
                    // Calculate and show percentage gain
                    if (accountBalanceSubtitleEl && data.starting_balance) {
                        const pctGain = ((data.account_balance - data.starting_balance) / data.starting_balance) * 100;
                        accountBalanceSubtitleEl.textContent = `Total Realized + Unrealized (${pctGain >= 0 ? '+' : ''}${pctGain.toFixed(3)}%)`;
                    }
                }

                // Update Realized P&L (completed trades only)
                const realizedPnlEl = document.getElementById('realized-pnl');
                const realizedPnlPctEl = document.getElementById('realized-pnl-pct');
                if (realizedPnlEl && data.realized_pnl !== undefined) {
                    realizedPnlEl.textContent = (data.realized_pnl >= 0 ? '+' : '-') + '$' + Math.abs(data.realized_pnl).toFixed(2);
                    realizedPnlEl.className = 'stat-value pnl ' + (data.realized_pnl >= 0 ? 'positive' : 'negative');
                    
                    // Calculate realized P&L percentage
                    if (realizedPnlPctEl && data.starting_balance) {
                        const realizedPct = (data.realized_pnl / data.starting_balance) * 100;
                        realizedPnlPctEl.textContent = `${realizedPct >= 0 ? '+' : ''}${realizedPct.toFixed(3)}% of starting`;
                    }
                }

                // Update Net P&L (realized + unrealized)
                const netPnlEl = document.getElementById('net-pnl');
                const netPnlPctEl = document.getElementById('net-pnl-pct');
                if (netPnlEl && data.net_pnl !== undefined) {
                    netPnlEl.textContent = (data.net_pnl >= 0 ? '+' : '') + '$' + Math.abs(data.net_pnl).toFixed(2);
                    netPnlEl.className = 'stat-value pnl ' + (data.net_pnl >= 0 ? 'positive' : 'negative');
                }
                if (netPnlPctEl && data.net_pnl_pct !== undefined) {
                    netPnlPctEl.textContent = `${data.net_pnl_pct >= 0 ? '+' : ''}${data.net_pnl_pct.toFixed(4)}%`;
                }

            } catch (error) {
                console.error('Failed to fetch account balance:', error);
                // Don't show error in UI - just log it
            }
        }

        async function updateLastEvent() {
            try {
                const response = await fetch('/api/trades/recent-signals?limit=1');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                if (data.count > 0 && data.signals && data.signals.length > 0) {
                    const latest = data.signals[0];
                    const lastEventEl = document.getElementById('last-event');
                    const lastEventTypeEl = document.getElementById('last-event-type');

                    if (lastEventEl && lastEventTypeEl) {
                        lastEventEl.textContent = new Date(latest.entry_time).toLocaleTimeString();
                        lastEventTypeEl.textContent = `${latest.direction} ${latest.symbol} @ $${latest.entry_price.toFixed(latest.entry_price > 1 ? 2 : 5)}`;
                    }
                }
            } catch (error) {
                console.error('Failed to update last event:', error);
                // Don't show error in UI - just log it
            }
        }

        // Load portfolio simulation data for Portfolio Performance card
        async function loadPortfolioPerformance() {
            try {
                const response = await fetch('/api/strategies/portfolio-simulation');
                if (!response.ok) {
                    console.warn('Portfolio simulation endpoint not available');
                    return;
                }
                const data = await response.json();

                // Find best performing strategy
                let bestStrategy = null;
                let bestReturn = -Infinity;
                let maxDrawdown = 0;

                if (data.strategies) {
                    data.strategies.forEach(strategy => {
                        const returns = strategy.total_return_pct || 0;
                        if (returns > bestReturn) {
                            bestReturn = returns;
                            bestStrategy = strategy;
                        }
                        // Track worst drawdown
                        const drawdown = Math.abs(strategy.max_drawdown_pct || 0);
                        if (drawdown > maxDrawdown) {
                            maxDrawdown = drawdown;
                        }
                    });
                }

                // Update main card stats
                const bestReturnEl = document.getElementById('portfolio-best-return');
                const maxDrawdownEl = document.getElementById('portfolio-max-drawdown');
                const bestStrategyEl = document.getElementById('portfolio-best-strategy');

                if (bestReturnEl && bestStrategy) {
                    bestReturnEl.textContent = `${bestReturn >= 0 ? '+' : ''}${bestReturn.toFixed(2)}%`;
                    bestReturnEl.className = 'card-main-stat ' + (bestReturn >= 0 ? 'pnl positive' : 'pnl negative');
                }

                if (maxDrawdownEl) {
                    maxDrawdownEl.textContent = `-${maxDrawdown.toFixed(2)}%`;
                }

                if (bestStrategyEl && bestStrategy) {
                    bestStrategyEl.textContent = bestStrategy.strategy_name || '--';
                }

                // Populate expandable strategy list
                const listEl = document.getElementById('portfolio-strategy-list');
                if (listEl && data.strategies) {
                    listEl.innerHTML = data.strategies.map(s => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">
                            <span style="color: var(--text-primary); font-weight: 600;">${s.strategy_name}</span>
                            <span class="pnl ${(s.total_return_pct || 0) >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">
                                ${(s.total_return_pct || 0) >= 0 ? '+' : ''}${(s.total_return_pct || 0).toFixed(2)}%
                            </span>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading portfolio performance:', error);
            }
        }

        // Load best performers data
        async function loadTopPerformers() {
            try {
                const response = await fetch('/api/account/balance');
                if (!response.ok) return;
                const data = await response.json();

                // For now, use placeholder data - you can expand this with actual API calls
                // Best Strategy
                const bestStrategyNameEl = document.getElementById('best-strategy-name');
                if (bestStrategyNameEl) {
                    bestStrategyNameEl.textContent = data.best_strategy || '--';
                }

                // Update system health
                const systemStatusEl = document.getElementById('system-status');
                const apiStatusEl = document.getElementById('api-status');
                const dbStatusEl = document.getElementById('db-status');
                const trackerStatusEl = document.getElementById('tracker-status');

                if (apiStatusEl) apiStatusEl.textContent = 'OK';
                if (dbStatusEl) dbStatusEl.textContent = 'OK';
                if (trackerStatusEl) trackerStatusEl.textContent = 'Active';

                // Update expandable total trades count
                const totalTradesEl = document.getElementById('account-total-trades');
                if (totalTradesEl && data.total_completed_trades !== undefined) {
                    totalTradesEl.textContent = data.total_completed_trades;
                }

            } catch (error) {
                console.error('Error loading top performers:', error);
            }
        }

        // =====================================================================
        // 3-Phase Strategy System Functions
        // =====================================================================
        
        async function loadPhaseSystemData() {
            try {
                // Load phase status for all symbols
                const response = await fetch('/api/strategies/all-phases');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                const summaries = data.summaries || [];
                
                // Update phase counts
                const phaseICounts = summaries.filter(s => s.phase === 'I').length;
                const phaseIICounts = summaries.filter(s => s.phase === 'II').length;
                const phaseIIICounts = summaries.filter(s => s.phase === 'III').length;
                
                document.getElementById('phase-i-count').textContent = phaseICounts;
                document.getElementById('phase-ii-count').textContent = phaseIICounts;
                document.getElementById('phase-iii-count').textContent = phaseIIICounts;
                
                // Find best strategy across all symbols
                let bestStrategy = '--';
                let bestScore = 0;
                summaries.forEach(s => {
                    if (s.best_strategy && s.best_strategy.performance) {
                        const score = s.best_strategy.performance.strategy_score;
                        if (score > bestScore) {
                            bestScore = score;
                            bestStrategy = s.best_strategy.strategy_name.replace('strategy_', 'Strategy ').toUpperCase();
                        }
                    }
                });
                document.getElementById('best-strategy-name').textContent = bestStrategy;
                
                // Populate phase status table
                const tableBody = document.getElementById('phase-status-table-body');
                if (summaries.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No trading data yet. Waiting for first webhook signals...
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = summaries.map(s => {
                        const phaseBadge = s.phase === 'I' ? 'warning' : s.phase === 'II' ? 'info' : 'success';
                        const progressText = s.phase === 'I' ? `${s.baseline_completed}/10` : s.baseline_completed;
                        const strategyName = s.best_strategy ? 
                            s.best_strategy.strategy_name.replace('strategy_', 'Strategy ').toUpperCase() : 
                            '--';
                        const performance = s.best_strategy && s.best_strategy.performance ?
                            `RR: ${s.best_strategy.performance.risk_reward.toFixed(2)} | WR: ${s.best_strategy.performance.win_rate.toFixed(1)}%` :
                            '--';
                        
                        return `
                            <tr onclick="loadStrategyDetailForSymbol('${s.symbol}', '${s.direction}', '${s.webhook_source}')" style="cursor: pointer;">
                                <td>${s.symbol}</td>
                                <td><span class="badge ${s.direction === 'LONG' ? 'success' : 'danger'}">${s.direction}</span></td>
                                <td><span class="badge info">${s.webhook_source}</span></td>
                                <td><span class="badge ${phaseBadge}">Phase ${s.phase}</span></td>
                                <td>${progressText}</td>
                                <td>${strategyName}</td>
                                <td style="font-size: 0.875rem;">${performance}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // Populate symbol filter dropdown
                const symbolFilter = document.getElementById('strategy-symbol-filter');
                const uniqueSymbols = [...new Set(summaries.map(s => `${s.symbol}|${s.direction}|${s.webhook_source}`))];
                symbolFilter.innerHTML = '<option value="">Select symbol...</option>' +
                    uniqueSymbols.map(combo => {
                        const [symbol, direction, webhook] = combo.split('|');
                        return `<option value="${combo}">${symbol} ${direction} (${webhook})</option>`;
                    }).join('');

                // Populate regeneration modal dropdown
                const regenSymbolSelect = document.getElementById('regen-symbol-select');
                regenSymbolSelect.innerHTML = '<option value="">Select symbol...</option>' +
                    uniqueSymbols.map(combo => {
                        const [symbol, direction, webhook] = combo.split('|');
                        return `<option value="${combo}">${symbol} ${direction} (${webhook})</option>`;
                    }).join('');

                // Update regeneration progress indicator
                updateRegenerationProgress(summaries);

            } catch (error) {
                console.error('Failed to load phase system data:', error);
                document.getElementById('phase-status-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--color-danger);">
                            Error loading phase data
                        </td>
                    </tr>
                `;
            }
        }

        // =====================================================================
        // REGENERATION PROGRESS FUNCTIONS
        // =====================================================================

        function updateRegenerationProgress(summaries) {
            if (!summaries || summaries.length === 0) {
                document.getElementById('regen-progress-text').textContent = '-- / 20 trades';
                document.getElementById('regen-progress-bar').style.width = '0%';
                document.getElementById('regen-progress-bar').textContent = '0%';
                document.getElementById('last-regen-time').textContent = '--';
                return;
            }

            // Find Phase II strategies (those actively being optimized)
            const phaseIIStrategies = summaries.filter(s => s.phase === 'II');

            if (phaseIIStrategies.length === 0) {
                document.getElementById('regen-progress-text').textContent = '0 / 20 trades';
                document.getElementById('regen-progress-bar').style.width = '0%';
                document.getElementById('regen-progress-bar').textContent = '0%';
                document.getElementById('last-regen-time').textContent = 'No Phase II strategies yet';
                return;
            }

            // Calculate average progress across all Phase II strategies
            const totalProgress = phaseIIStrategies.reduce((sum, s) => sum + (s.baseline_completed % 20), 0);
            const avgProgress = Math.floor(totalProgress / phaseIIStrategies.length);
            const percentage = Math.floor((avgProgress / 20) * 100);

            // Update progress text and bar
            document.getElementById('regen-progress-text').textContent = `${avgProgress} / 20 trades`;
            document.getElementById('regen-progress-bar').style.width = `${percentage}%`;
            document.getElementById('regen-progress-bar').textContent = `${percentage}%`;

            // Find latest regeneration timestamp (created_at from strategies)
            let latestTimestamp = null;
            phaseIIStrategies.forEach(s => {
                if (s.best_strategy && s.best_strategy.created_at) {
                    const timestamp = new Date(s.best_strategy.created_at);
                    if (!latestTimestamp || timestamp > latestTimestamp) {
                        latestTimestamp = timestamp;
                    }
                }
            });

            // Update last regeneration time
            if (latestTimestamp) {
                document.getElementById('last-regen-time').textContent = getRelativeTime(latestTimestamp);
            } else {
                document.getElementById('last-regen-time').textContent = 'Never';
            }
        }

        function getRelativeTime(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) {
                return 'Just now';
            } else if (diffMin < 60) {
                return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
            } else if (diffHour < 24) {
                return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
            } else if (diffDay < 7) {
                return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
            } else {
                return past.toLocaleDateString();
            }
        }

        function showRegenerationDialog() {
            const modal = document.getElementById('regen-modal');
            modal.style.display = 'flex';
        }

        function closeRegenerationDialog() {
            const modal = document.getElementById('regen-modal');
            modal.style.display = 'none';
        }

        async function confirmRegeneration() {
            const select = document.getElementById('regen-symbol-select');
            const selectedValue = select.value;

            if (!selectedValue) {
                showToast('error', 'Selection Required', 'Please select a symbol to regenerate strategies for.');
                return;
            }

            const [symbol, direction, webhookSource] = selectedValue.split('|');

            // Disable button and show loading state
            const btn = document.querySelector('.regen-modal-btn.confirm');
            const originalText = btn.textContent;
            btn.textContent = 'Regenerating...';
            btn.disabled = true;

            try {
                const response = await fetch(`/api/strategies/regenerate/${symbol}/${direction}/${webhookSource}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                // Close modal
                closeRegenerationDialog();

                // Show success toast
                showToast('success', 'Regeneration Complete', `Successfully regenerated strategies for ${symbol} ${direction} (${webhookSource})`);

                // Reload phase system data to update UI
                await loadPhaseSystemData();

            } catch (error) {
                console.error('Failed to regenerate strategies:', error);
                showToast('error', 'Regeneration Failed', error.message || 'An error occurred while regenerating strategies.');
            } finally {
                // Re-enable button
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function showToast(type, title, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const iconMap = {
                success: '✓',
                error: '✕',
                info: 'ℹ'
            };

            toast.innerHTML = `
                <div class="toast-icon">${iconMap[type] || 'ℹ'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">&times;</button>
            `;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                removeToast(toast);
            }, 5000);
        }

        function closeToast(button) {
            const toast = button.closest('.toast');
            removeToast(toast);
        }

        function removeToast(toast) {
            toast.classList.add('hiding');
            setTimeout(() => {
                toast.remove();
            }, 300); // Match animation duration
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('regen-modal');
            if (event.target === modal) {
                closeRegenerationDialog();
            }
        }

        async function loadStrategyDetailForSymbol(symbol, direction, webhookSource) {
            try {
                // Load strategy performance for this symbol
                const response = await fetch(`/api/strategies/performance/${symbol}/${direction}/${webhookSource}`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                const strategies = data.strategies || [];
                
                if (strategies.length === 0) {
                    // Still in Phase I or strategies haven't been generated yet
                    alert(`${symbol} ${direction} is still in Phase I (baseline collection). Strategies will be generated after 10 baseline trades complete.`);
                    return;
                }
                
                // Update symbol filter to select this symbol
                document.getElementById('strategy-symbol-filter').value = `${symbol}|${direction}|${webhookSource}`;
                
                // Update strategy cards
                updateStrategyCards(strategies, symbol, direction, webhookSource);
                
                // Scroll to strategy section
                document.getElementById('strategy-cards-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                console.error('Failed to load strategy detail:', error);
                alert('Error loading strategy details');
            }
        }
        
        async function updateStrategyPerformance() {
            const selectedValue = document.getElementById('strategy-symbol-filter').value;
            if (!selectedValue) {
                // Clear strategy cards
                document.getElementById('strategy-a-rr').textContent = '--';
                document.getElementById('strategy-a-wr').textContent = '--';
                document.getElementById('strategy-a-trades').textContent = '--';
                document.getElementById('strategy-a-eligible').textContent = '⏳ Not eligible';
                
                document.getElementById('strategy-b-rr').textContent = '--';
                document.getElementById('strategy-b-wr').textContent = '--';
                document.getElementById('strategy-b-trades').textContent = '--';
                document.getElementById('strategy-b-eligible').textContent = '⏳ Not eligible';
                
                document.getElementById('strategy-c-rr').textContent = '--';
                document.getElementById('strategy-c-wr').textContent = '--';
                document.getElementById('strategy-c-trades').textContent = '--';
                document.getElementById('strategy-c-eligible').textContent = '⏳ Not eligible';
                
                document.getElementById('strategy-d-rr').textContent = '--';
                document.getElementById('strategy-d-wr').textContent = '--';
                document.getElementById('strategy-d-trades').textContent = '--';
                document.getElementById('strategy-d-eligible').textContent = '⏳ Not eligible';
                
                // Hide current strategy params
                document.getElementById('current-strategy-params').style.display = 'none';
                
                // Clear chart
                if (charts.strategyComparison) {
                    charts.strategyComparison.destroy();
                    delete charts.strategyComparison;
                }
                
                return;
            }
            
            const [symbol, direction, webhookSource] = selectedValue.split('|');
            
            try {
                const response = await fetch(`/api/strategies/performance/${symbol}/${direction}/${webhookSource}`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                const strategies = data.strategies || [];
                
                updateStrategyCards(strategies, symbol, direction, webhookSource);
                
            } catch (error) {
                console.error('Failed to load strategy performance:', error);
            }
        }
        
        function updateStrategyCards(strategies, symbol, direction, webhookSource) {
            const strategyMap = {
                'strategy_A': 'a',
                'strategy_B': 'b',
                'strategy_C': 'c',
                'strategy_D': 'd'
            };
            
            // Update each strategy card
            strategies.forEach(s => {
                const letter = strategyMap[s.strategy_name];
                if (!letter) return;
                
                document.getElementById(`strategy-${letter}-rr`).textContent = 
                    s.risk_reward ? `RR ${s.risk_reward.toFixed(2)}` : '--';
                document.getElementById(`strategy-${letter}-wr`).textContent = 
                    s.win_rate ? `${s.win_rate.toFixed(1)}%` : '--';
                document.getElementById(`strategy-${letter}-trades`).textContent = 
                    s.trades_analyzed || 0;
                
                const eligibleEl = document.getElementById(`strategy-${letter}-eligible`);
                if (s.is_eligible_phase3) {
                    eligibleEl.textContent = '✅ Phase III Ready';
                    eligibleEl.style.color = 'var(--color-success)';
                } else {
                    const reasons = [];
                    if (!s.meets_rr) reasons.push('RR<1.0');
                    if (!s.has_real_sl) reasons.push('No SL');
                    if (!s.meets_duration) reasons.push('>24h');
                    eligibleEl.textContent = reasons.length > 0 ? `⏳ ${reasons.join(', ')}` : '⏳ Not eligible';
                    eligibleEl.style.color = 'var(--color-warning)';
                }
                
                // Highlight best strategy
                const card = document.getElementById(`strategy-${letter}-card`);
                if (s.is_eligible_phase3 && s.strategy_score === Math.max(...strategies.filter(st => st.is_eligible_phase3).map(st => st.strategy_score))) {
                    card.style.boxShadow = '0 0 20px rgba(212, 175, 55, 0.4)';
                    card.style.borderLeft = '4px solid var(--color-accent)';
                } else {
                    card.style.boxShadow = '';
                    card.style.borderLeft = '';
                }
            });
            
            // Show current strategy parameters for best strategy
            const bestStrategy = strategies.find(s => s.is_eligible_phase3);
            if (bestStrategy && bestStrategy.current_params) {
                document.getElementById('current-strategy-params').style.display = 'block';
                document.getElementById('current-tp1').textContent = 
                    bestStrategy.current_params.tp1 ? `${bestStrategy.current_params.tp1.toFixed(2)}%` : '--';
                document.getElementById('current-tp2').textContent = 
                    bestStrategy.current_params.tp2 ? `${bestStrategy.current_params.tp2.toFixed(2)}%` : '--';
                document.getElementById('current-tp3').textContent = 
                    bestStrategy.current_params.tp3 ? `${bestStrategy.current_params.tp3.toFixed(2)}%` : '--';
                document.getElementById('current-sl').textContent = 
                    bestStrategy.current_params.sl ? `${bestStrategy.current_params.sl.toFixed(2)}%` : '--';
                document.getElementById('current-trailing').textContent = 
                    bestStrategy.current_params.trailing ? 'Enabled' : 'Disabled';
            } else {
                document.getElementById('current-strategy-params').style.display = 'none';
            }
            
            // Update comparison chart
            updateStrategyComparisonChart(strategies);
        }
        
        function updateStrategyComparisonChart(strategies) {
            const canvas = document.getElementById('strategy-comparison-chart');
            const ctx = canvas.getContext('2d');
            
            if (charts.strategyComparison) {
                charts.strategyComparison.destroy();
            }
            
            const colors = {
                'strategy_A': '#3b82f6',
                'strategy_B': '#8b5cf6',
                'strategy_C': '#10b981',
                'strategy_D': '#f59e0b'
            };
            
            charts.strategyComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: strategies.map(s => s.strategy_name.replace('strategy_', 'Strategy ')),
                    datasets: [
                        {
                            label: 'Risk/Reward',
                            data: strategies.map(s => s.risk_reward || 0),
                            backgroundColor: strategies.map(s => colors[s.strategy_name] + '80'),
                            borderColor: strategies.map(s => colors[s.strategy_name]),
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Win Rate (%)',
                            data: strategies.map(s => s.win_rate || 0),
                            backgroundColor: strategies.map(s => colors[s.strategy_name] + '40'),
                            borderColor: strategies.map(s => colors[s.strategy_name]),
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const strategy = strategies[context.dataIndex];
                                    return [
                                        `Trades: ${strategy.trades_analyzed}`,
                                        `Avg Win: ${strategy.avg_win ? strategy.avg_win.toFixed(2) + '%' : '--'}`,
                                        `Avg Loss: ${strategy.avg_loss ? strategy.avg_loss.toFixed(2) + '%' : '--'}`,
                                        `Score: ${strategy.strategy_score ? strategy.strategy_score.toFixed(3) : '--'}`,
                                        strategy.is_eligible_phase3 ? '✅ Phase III Ready' : '⏳ Not Eligible'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Risk/Reward Ratio',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Win Rate (%)',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        function toggleStrategyOverlay(strategyLetter) {
            // This will be used for overlaying strategy performance on price charts
            // For now, just log it
            const checkbox = document.getElementById(`strategy-${strategyLetter.toLowerCase()}-toggle`);
            console.log(`Strategy ${strategyLetter} overlay:`, checkbox.checked);
            
            // TODO: Implement overlay on price/PnL charts
            // This would show where each strategy would have exited trades
        }
        
        // =====================================================================
        // Original Functions
        // =====================================================================
        
        async function loadStrategiesPerformance() {
            try {
                const response = await fetch('/api/strategies/parallel-comparison');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                const summaryEl = document.getElementById('strategies-summary');
                const contentEl = document.getElementById('strategies-content');

                if (!data.sources || data.sources.length === 0) {
                    if (summaryEl) summaryEl.textContent = 'No parallel testing data yet (baseline mode active)';
                    if (contentEl) {
                        contentEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">📊</div>
                                <p>Parallel A/B/C/D testing starts after 10 baseline trades</p>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem;">Currently collecting baseline data...</p>
                            </div>
                        `;
                    }
                    return;
                }

                // Build summary
                let totalSignals = 0;
                let strategyWins = { static: 0, adaptive_trailing: 0, early_momentum: 0, ai_filtered: 0 };
                let strategyCounts = { static: 0, adaptive_trailing: 0, early_momentum: 0, ai_filtered: 0 };

                let sourceCounts = {};

                data.sources.forEach(source => {
                    totalSignals += source.total_signals || 0;
                    if (source.strategy_wins) {
                        Object.keys(source.strategy_wins).forEach(strategy => {
                            strategyWins[strategy] = (strategyWins[strategy] || 0) + (source.strategy_wins[strategy] || 0);
                        });
                    }
                    // Count trades per strategy
                    if (source.symbols) {
                        source.symbols.forEach(symbol => {
                            if (symbol.strategy_performance) {
                                Object.keys(symbol.strategy_performance).forEach(strategy => {
                                    if (strategyCounts[strategy] !== undefined) {
                                        strategyCounts[strategy] += symbol.strategy_performance[strategy].count || 0;
                                    }
                                });
                            }
                        });
                    }
                    // Count trades per source (ADX1m, ADX5m, etc)
                    const sourceName = source.source || 'Unknown';
                    sourceCounts[sourceName] = (sourceCounts[sourceName] || 0) + (source.total_signals || 0);
                });

                const totalCompleted = Object.values(strategyWins).reduce((a, b) => a + b, 0);

                if (summaryEl) {
                    // Show top 2 sources by trade count
                    const topSources = Object.entries(sourceCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 2);

                    if (topSources.length > 0) {
                        const summaryParts = topSources.map(([name, count]) => `${name}: ${count} trade${count !== 1 ? 's' : ''}`);
                        summaryEl.textContent = summaryParts.join(' • ');
                    } else {
                        summaryEl.textContent = `${totalSignals} signals | All trades still active`;
                    }
                }

                // Render strategies content
                renderStrategiesContent(data.sources);

            } catch (error) {
                console.error('Error loading strategies:', error);
                const contentEl = document.getElementById('strategies-content');
                if (contentEl) {
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <p>Unable to load strategy data</p>
                        </div>
                    `;
                }
            }
        }

        function renderStrategiesContent(sources) {
            let html = '';

            if (!sources || sources.length === 0) {
                const contentEl = document.getElementById('strategies-content');
                if (contentEl) {
                    contentEl.innerHTML = '<div class="empty-state"><p>No strategy data available</p></div>';
                }
                return;
            }

            sources.forEach(source => {
                if (!source.symbols || source.symbols.length === 0) return;

                source.symbols.forEach(symbol => {
                    if (!symbol.strategy_performance) return;

                    const strats = symbol.strategy_performance;
                    const ranked = [
                        { name: 'A: Static', key: 'static', pnl: strats.static?.avg_pnl || 0, count: strats.static?.count || 0 },
                        { name: 'B: Adaptive Trailing', key: 'adaptive_trailing', pnl: strats.adaptive_trailing?.avg_pnl || 0, count: strats.adaptive_trailing?.count || 0 },
                        { name: 'C: Early Momentum', key: 'early_momentum', pnl: strats.early_momentum?.avg_pnl || 0, count: strats.early_momentum?.count || 0 }
                    ].sort((a, b) => b.pnl - a.pnl);

                    html += `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: var(--color-accent); margin-bottom: 1rem;">${symbol.symbol || 'Unknown'}</h3>
                            <div class="strategy-grid">
                                ${ranked.map((s, idx) => {
                                    const stratData = strats[s.key] || { avg_pnl: 0, count: 0, total_pnl: 0 };
                                    return `
                                    <div class="strategy-card ${idx === 0 ? 'winner' : ''}">
                                        <div class="strategy-name">
                                            <span class="badge strategy-${s.key.split('_')[0]}">${s.name}</span>
                                            ${idx === 0 ? ' 🏆' : ''}
                                        </div>
                                        <div class="strategy-stats">
                                            <div>Avg P&L: <span class="pnl ${s.pnl >= 0 ? 'positive' : 'negative'}">${s.pnl >= 0 ? '+' : ''}${s.pnl.toFixed(2)}%</span></div>
                                            <div>Signals: ${s.count}</div>
                                            <div>Total: <span class="pnl ${stratData.total_pnl >= 0 ? 'positive' : 'negative'}">${stratData.total_pnl >= 0 ? '+' : ''}${stratData.total_pnl.toFixed(2)}%</span></div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                });
            });

            const contentEl = document.getElementById('strategies-content');
            if (contentEl) {
                contentEl.innerHTML = html || '<div class="empty-state"><p>No strategy data available</p></div>';
            }
        }

        async function loadSymbolsBreakdown() {
            try {
                const response = await fetch('/api/trades/active');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                const trades = data.trades || [];

                const summaryEl = document.getElementById('symbols-summary');
                const contentEl = document.getElementById('symbols-content');

                if (!contentEl) return;

                // Handle empty data
                if (trades.length === 0) {
                    if (summaryEl) summaryEl.textContent = 'No active trades';
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📊</div>
                            <p>No active trades yet</p>
                        </div>
                    `;
                    return;
                }

                // Group by symbol
                const bySymbol = {};
                trades.forEach(trade => {
                    if (!trade.symbol) return;
                    if (!bySymbol[trade.symbol]) {
                        bySymbol[trade.symbol] = [];
                    }
                    bySymbol[trade.symbol].push(trade);
                });

                // Find top symbol by number of trades
                const symbolCounts = Object.entries(bySymbol).map(([symbol, symbolTrades]) => ({
                    symbol,
                    count: symbolTrades.length
                }));
                symbolCounts.sort((a, b) => b.count - a.count);
                const topSymbol = symbolCounts.length > 0 ? symbolCounts[0].symbol : 'None';

                // Update summary
                if (summaryEl) {
                    summaryEl.textContent = `${Object.keys(bySymbol).length} unique symbol${Object.keys(bySymbol).length !== 1 ? 's' : ''} • Top: ${topSymbol}`;
                }

                // Render table
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Active Trades</th>
                                <th>Avg P&L</th>
                                <th>Total Exposure</th>
                                <th>Strategies</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.entries(bySymbol).forEach(([symbol, symbolTrades]) => {
                    // Exclude baseline trades from P&L calculation
                    const strategyTrades = symbolTrades.filter(t => t.risk_strategy !== 'baseline');
                    const avgPnl = strategyTrades.length > 0
                        ? strategyTrades.reduce((sum, t) => sum + (parseFloat(t.current_pnl_pct) || 0), 0) / strategyTrades.length
                        : 0;
                    const totalExposure = symbolTrades.reduce((sum, t) => sum + (parseFloat(t.notional_position_usd) || 0), 0);
                    const strategies = [...new Set(symbolTrades.map(t => t.risk_strategy || 'baseline'))];

                    // Display P&L or "DATA" label
                    const pnlDisplay = strategyTrades.length > 0
                        ? `<span class="pnl ${avgPnl >= 0 ? 'positive' : 'negative'}">${avgPnl >= 0 ? '+' : ''}${avgPnl.toFixed(2)}%</span>`
                        : '<span style="color: var(--text-secondary); font-size: 0.9em;">📊 DATA</span>';

                    html += `
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td>${symbolTrades.length}</td>
                            <td>${pnlDisplay}</td>
                            <td>$${totalExposure.toFixed(2)}</td>
                            <td>${strategies.map(s => `<span class="badge strategy-${s.split('_')[0]}">${s[0].toUpperCase()}</span>`).join(' ')}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                contentEl.innerHTML = html;

            } catch (error) {
                console.error('Error loading symbols breakdown:', error);
                const contentEl = document.getElementById('symbols-content');
                if (contentEl) {
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <p>Unable to load symbol data</p>
                        </div>
                    `;
                }
            }
        }

        // =====================================================================
        // Strategy Analytics
        // =====================================================================
        let currentStrategyAnalyticsFilter = 'all';
        let strategyPnlChart = null;
        let showTradePnL = false;  // Hide individual trade P&L by default
        let showDrawdown = false;  // Hide drawdown by default

        function toggleTradePnL() {
            showTradePnL = !showTradePnL;
            const btn = document.getElementById('toggle-trade-pnl');
            if (btn) {
                btn.textContent = showTradePnL ? 'Hide Individual Trades' : 'Show Individual Trades';
            }

            // Toggle dataset visibility if chart exists
            if (strategyPnlChart && strategyPnlChart.data.datasets[1]) {
                strategyPnlChart.data.datasets[1].hidden = !showTradePnL;
                strategyPnlChart.update('none');
            }
        }

        function toggleDrawdown() {
            showDrawdown = !showDrawdown;
            const btn = document.getElementById('toggle-drawdown');
            if (btn) {
                btn.textContent = showDrawdown ? 'Hide Drawdown' : 'Show Drawdown';
            }

            // Toggle dataset visibility if chart exists
            if (strategyPnlChart && strategyPnlChart.data.datasets[2]) {
                strategyPnlChart.data.datasets[2].hidden = !showDrawdown;
                strategyPnlChart.update('none');
            }
        }

        // Load analytics strategy filters dynamically from API
        async function loadAnalyticsStrategyFilters() {
            try {
                const response = await fetch('/api/strategies');
                if (!response.ok) {
                    console.error('Failed to load strategies for analytics:', response.status);
                    return;
                }

                const data = await response.json();
                const container = document.getElementById('analytics-strategy-filters');

                if (!container) {
                    console.error('Analytics strategy filters container not found');
                    return;
                }

                // Keep the ALL button (already in HTML)
                const allButton = container.querySelector('.strategy-all');
                container.innerHTML = '';
                if (allButton) {
                    container.appendChild(allButton);
                }

                // Add buttons for each unique strategy
                if (data.strategies && data.strategies.length > 0) {
                    data.strategies.forEach(strategy => {
                        const button = document.createElement('button');
                        button.className = 'filter-btn';
                        button.textContent = strategy.name;
                        button.onclick = () => filterStrategyAnalytics(strategy.name);

                        // Add count badge if there are completed trades
                        if (strategy.total_trades > 0) {
                            const badge = document.createElement('span');
                            badge.style.cssText = 'margin-left: 0.5rem; padding: 0.125rem 0.375rem; background: rgba(0, 212, 255, 0.2); border-radius: 4px; font-size: 0.75rem;';
                            badge.textContent = strategy.total_trades;
                            button.appendChild(badge);
                        }

                        container.appendChild(button);
                    });

                    console.log(`Loaded ${data.strategies.length} analytics strategy filters`);
                } else {
                    console.log('No strategies found for analytics, using default ALL filter only');
                }
            } catch (error) {
                console.error('Error loading analytics strategy filters:', error);
            }
        }

        async function loadAnalytics() {
            // Load strategy filters and analytics when analytics tab is opened
            await loadAnalyticsStrategyFilters();
            await loadStrategyAnalytics(currentStrategyAnalyticsFilter);
        }

        async function filterStrategyAnalytics(strategy) {
            currentStrategyAnalyticsFilter = strategy;

            // Update button states
            const parentDiv = event.target.closest('.strategy-filters');
            if (parentDiv) {
                parentDiv.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }

            // Reload analytics with new filter
            await loadStrategyAnalytics(strategy);
        }

        async function loadStrategyAnalytics(strategy) {
            try {
                // Show loading state
                const loadingEl = document.getElementById('strategy-analytics-loading');
                const statsCardsEl = document.getElementById('strategy-stats-cards');
                const comparisonTableEl = document.getElementById('strategy-comparison-table');
                const titleEl = document.getElementById('strategy-analytics-title');
                const summaryEl = document.getElementById('strategy-analytics-summary');

                if (loadingEl) loadingEl.style.display = 'block';
                if (statsCardsEl) statsCardsEl.style.display = 'none';
                if (comparisonTableEl) comparisonTableEl.style.display = 'none';

                // Fetch data from API
                const url = strategy === 'all'
                    ? '/api/analytics/by-strategy'
                    : `/api/analytics/by-strategy?strategy=${strategy}`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                // Hide loading
                if (loadingEl) loadingEl.style.display = 'none';

                // Update title and summary
                if (titleEl) {
                    titleEl.textContent = strategy === 'all'
                        ? 'Strategy Performance Analytics - All Strategies'
                        : `Strategy Performance Analytics - ${strategy}`;
                }

                if (strategy === 'all') {
                    // Show comparison table
                    if (summaryEl) {
                        summaryEl.textContent = `Comparing ${data.strategies_comparison.length} strategies across ${data.total_trades} trades`;
                    }

                    if (comparisonTableEl) {
                        comparisonTableEl.style.display = 'block';
                        renderStrategyComparisonTable(data.strategies_comparison);
                    }
                } else {
                    // Show detailed stats cards for specific strategy
                    if (summaryEl) {
                        summaryEl.textContent = `${data.total_trades} completed trades | ${data.win_rate}% win rate`;
                    }

                    if (statsCardsEl) {
                        statsCardsEl.style.display = 'block';
                        updateStrategyStatsCards(data);
                    }
                }

                // Render P&L chart
                renderStrategyPnlChart(data.time_series, strategy);

            } catch (error) {
                console.error('Error loading strategy analytics:', error);
                const loadingEl = document.getElementById('strategy-analytics-loading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <p>Error loading strategy analytics</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function updateStrategyStatsCards(data) {
            // Update stat cards for specific strategy
            const winRateEl = document.getElementById('strategy-win-rate');
            const totalTradesEl = document.getElementById('strategy-total-trades');
            const avgPnlEl = document.getElementById('strategy-avg-pnl');
            const totalPnlEl = document.getElementById('strategy-total-pnl');
            const bestTradeEl = document.getElementById('strategy-best-trade');
            const bestSymbolEl = document.getElementById('strategy-best-symbol');
            const worstTradeEl = document.getElementById('strategy-worst-trade');
            const worstSymbolEl = document.getElementById('strategy-worst-symbol');

            if (winRateEl) winRateEl.textContent = `${data.win_rate}%`;
            if (totalTradesEl) totalTradesEl.textContent = data.total_trades;

            if (avgPnlEl) {
                const avgPnl = data.avg_pnl_per_trade;
                avgPnlEl.textContent = `${avgPnl >= 0 ? '+' : ''}${avgPnl.toFixed(2)}%`;
                avgPnlEl.className = `stat-value ${avgPnl >= 0 ? '' : 'pnl negative'}`;
            }

            if (totalPnlEl) {
                const totalPnl = data.total_realized_pnl;
                totalPnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)}%`;
                totalPnlEl.className = `stat-value ${totalPnl >= 0 ? '' : 'pnl negative'}`;
            }

            if (data.best_trade) {
                if (bestTradeEl) {
                    bestTradeEl.textContent = `+${data.best_trade.pnl_pct.toFixed(2)}%`;
                    bestTradeEl.className = 'stat-value pnl positive';
                }
                if (bestSymbolEl) {
                    bestSymbolEl.textContent = `${data.best_trade.symbol} ${data.best_trade.direction}`;
                }
            }

            if (data.worst_trade) {
                if (worstTradeEl) {
                    worstTradeEl.textContent = `${data.worst_trade.pnl_pct.toFixed(2)}%`;
                    worstTradeEl.className = 'stat-value pnl negative';
                }
                if (worstSymbolEl) {
                    worstSymbolEl.textContent = `${data.worst_trade.symbol} ${data.worst_trade.direction}`;
                }
            }
        }

        function renderStrategyComparisonTable(strategies) {
            const tbody = document.getElementById('strategy-comparison-body');
            if (!tbody) return;

            let html = '';
            strategies.forEach(strat => {
                const winRateColor = strat.win_rate >= 50 ? 'positive' : 'negative';
                const avgPnlColor = strat.avg_pnl_per_trade >= 0 ? 'positive' : 'negative';
                const totalPnlColor = strat.total_realized_pnl >= 0 ? 'positive' : 'negative';
                const bestColor = strat.best_trade >= 0 ? 'positive' : 'negative';
                const worstColor = strat.worst_trade >= 0 ? 'positive' : 'negative';

                html += `
                    <tr>
                        <td><strong>${strat.strategy}</strong></td>
                        <td><span class="pnl ${winRateColor}">${strat.win_rate}%</span></td>
                        <td>${strat.total_trades}</td>
                        <td><span class="pnl ${avgPnlColor}">${strat.avg_pnl_per_trade >= 0 ? '+' : ''}${strat.avg_pnl_per_trade.toFixed(2)}%</span></td>
                        <td><span class="pnl ${totalPnlColor}">${strat.total_realized_pnl >= 0 ? '+' : ''}${strat.total_realized_pnl.toFixed(2)}%</span></td>
                        <td><span class="pnl ${bestColor}">${strat.best_trade >= 0 ? '+' : ''}${strat.best_trade.toFixed(2)}%</span></td>
                        <td><span class="pnl ${worstColor}">${strat.worst_trade >= 0 ? '+' : ''}${strat.worst_trade.toFixed(2)}%</span></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function renderStrategyPnlChart(timeSeries, strategy) {
            const ctx = document.getElementById('strategy-pnl-chart');
            if (!ctx) return;

            if (!timeSeries || timeSeries.length === 0) {
                if (strategyPnlChart) {
                    strategyPnlChart.destroy();
                    strategyPnlChart = null;
                }
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            // Prepare data
            const labels = timeSeries.map(t => new Date(t.timestamp).toLocaleString());
            const cumulativePnl = timeSeries.map(t => t.cumulative_pnl);
            const tradePnl = timeSeries.map(t => t.pnl_pct);
            const drawdown = timeSeries.map(t => t.drawdown || 0);

            // Determine if multi-strategy view (ALL)
            const isMultiStrategy = strategy === 'all';

            // Update existing chart if it exists
            if (strategyPnlChart) {
                strategyPnlChart.data.labels = labels;
                strategyPnlChart.data.datasets[0].data = cumulativePnl;
                strategyPnlChart.data.datasets[1].data = tradePnl;
                strategyPnlChart.data.datasets[2].data = drawdown;
                strategyPnlChart.update('none');
                return;
            }

            // Create new chart only if it doesn't exist
            strategyPnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cumulative P&L (%)',
                            data: cumulativePnl,
                            borderColor: '#D4AF37',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            hidden: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Trade P&L (%)',
                            data: tradePnl,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.05)',
                            borderWidth: 1,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            hidden: true,  // Hidden by default
                            yAxisID: 'y'
                        },
                        {
                            label: 'Drawdown (%)',
                            data: drawdown,
                            borderColor: '#ff4444',
                            backgroundColor: 'rgba(255, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            hidden: true,  // Hidden by default
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 41, 0.95)',
                            titleColor: '#e0e0e0',
                            bodyColor: '#8892b0',
                            borderColor: '#2a3050',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const trade = timeSeries[index];
                                    return `${trade.symbol || ''} - ${new Date(trade.timestamp).toLocaleString()}`;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
                                },
                                afterLabel: function(context) {
                                    if (isMultiStrategy) {
                                        const index = context.dataIndex;
                                        const trade = timeSeries[index];
                                        return `Strategy: ${trade.strategy || 'unknown'}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: false,  // Don't force scale to start at 0
                            grace: '5%',  // Add 5% padding to top/bottom for better visualization
                            ticks: {
                                color: '#8892b0',
                                callback: function(value) {
                                    return value >= 0 ? `+${value}%` : `${value}%`;
                                }
                            },
                            grid: {
                                color: 'rgba(42, 48, 80, 0.3)',
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }

        async function loadRecentSignals() {
            try {
                const response = await fetch('/api/trades/recent-signals?limit=10');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                const summaryEl = document.getElementById('recent-summary');
                const contentEl = document.getElementById('recent-content');

                if (!data.signals || data.signals.length === 0) {
                    if (summaryEl) summaryEl.textContent = 'No signals yet';
                    if (contentEl) {
                        contentEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">📡</div>
                                <p>No webhook signals received yet</p>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem;">Waiting for TradingView alerts...</p>
                            </div>
                        `;
                    }
                    return;
                }

                // Calculate signals today and avg AI score
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const signalsToday = data.signals.filter(s => {
                    const signalDate = new Date(s.entry_time);
                    signalDate.setHours(0, 0, 0, 0);
                    return signalDate.getTime() === today.getTime();
                }).length;

                const aiScores = data.signals.filter(s => s.ai_quality_score).map(s => s.ai_quality_score);
                const avgAiScore = aiScores.length > 0 ? (aiScores.reduce((a, b) => a + b, 0) / aiScores.length) : 0;

                if (summaryEl) {
                    summaryEl.textContent = `${signalsToday} signal${signalsToday !== 1 ? 's' : ''} today • ${avgAiScore.toFixed(1)}% avg AI score`;
                }

                // Render table
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>Entry Price</th>
                                <th>Source</th>
                                <th>Strategy</th>
                                <th>Mode</th>
                                <th>AI Score</th>
                                <th>Status</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.signals.forEach(signal => {
                    const time = new Date(signal.entry_time);
                    const timeStr = time.toLocaleTimeString();
                    const aiScore = signal.ai_quality_score ? signal.ai_quality_score.toFixed(1) : '--';
                    const pnl = signal.final_pnl_pct ? `${signal.final_pnl_pct >= 0 ? '+' : ''}${signal.final_pnl_pct.toFixed(2)}%` : '--';

                    html += `
                        <tr class="clickable-row" onclick="openTradeDetailsModal(${signal.id})" title="Click for details">
                            <td style="font-size: 0.85em;">${timeStr}</td>
                            <td><strong>${signal.symbol}</strong></td>
                            <td><span class="badge ${signal.direction.toLowerCase()}">${signal.direction}</span></td>
                            <td>$${signal.entry_price.toFixed(signal.entry_price > 1 ? 2 : 6)}</td>
                            <td><span class="badge info">${signal.webhook_source || 'unknown'}</span></td>
                            <td><span class="badge strategy-${signal.risk_strategy ? signal.risk_strategy.split('_')[0] : 'baseline'}">${signal.risk_strategy || 'baseline'}</span></td>
                            <td><span class="badge ${signal.trade_mode}">${signal.trade_mode || 'live'}</span></td>
                            <td>${aiScore}/10</td>
                            <td><span class="badge ${signal.status === 'active' ? 'live' : 'baseline'}">${signal.status}</span></td>
                            <td><span class="pnl ${signal.final_pnl_pct && signal.final_pnl_pct >= 0 ? 'positive' : 'negative'}">${pnl}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                if (contentEl) contentEl.innerHTML = html;

            } catch (error) {
                console.error('Error loading recent signals:', error);
                const contentEl = document.getElementById('recent-content');
                if (contentEl) {
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <p>Unable to load recent signals</p>
                        </div>
                    `;
                }
            }
        }

        async function loadLiveTrades() {
            try {
                // Load websocket stats
                const wsResponse = await fetch('/api/websocket/stats');
                if (wsResponse.ok) {
                    const wsData = await wsResponse.json();

                    const wsStatus = document.getElementById('ws-status');
                    const wsConnections = document.getElementById('ws-connections');

                    if (wsStatus) {
                        wsStatus.textContent = wsData.websocket_stats ? 'Active' : 'Inactive';
                    }
                    if (wsConnections) {
                        wsConnections.textContent = (wsData.websocket_stats && wsData.websocket_stats.active_websockets) || 0;
                    }
                }

                // Load live trading activity with filters
                const response = await fetch(`/api/trades/live-activity?status=${currentStatusFilter}&period=${currentPeriodFilter}`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                const contentEl = document.getElementById('live-trades-content');
                const summaryEl = document.getElementById('live-trades-summary');

                if (!data.trades || data.trades.length === 0) {
                    if (summaryEl) {
                        summaryEl.textContent = 'No active trades';
                    }
                    if (contentEl) {
                        contentEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">💤</div>
                                <p>No active trades currently</p>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem;">Waiting for new signals...</p>
                            </div>
                        `;
                    }
                    return;
                }

                // Filter trades by strategy (for table display only)
                let filteredTrades = data.trades;
                if (currentStrategyFilter !== 'all') {
                    filteredTrades = data.trades.filter(trade =>
                        trade.webhook_source && trade.webhook_source.toLowerCase() === currentStrategyFilter.toLowerCase()
                    );
                }

                // Use summary from API response (has real totals, not just paginated)
                const filteredSummary = data.summary;

                // Update summary with dynamic data
                if (summaryEl) {
                    // Use total_count from API (real count, not paginated)
                    const activeTrades = data.total_count || data.count;
                    const pnlSign = filteredSummary.total_pnl_usd >= 0 ? '+' : '';
                    const pnlNote = filteredSummary.strategy_count > 0 ?
                        ` (${filteredSummary.strategy_count} strategy trades)` :
                        ' (baseline only - no P&L)';
                    summaryEl.textContent = `${activeTrades} active trade${activeTrades !== 1 ? 's' : ''} • ${pnlSign}$${filteredSummary.total_pnl_usd.toFixed(2)} P&L${pnlNote} • $${filteredSummary.total_exposure_usd.toFixed(2)} exposure`;
                }

                // Render live trades table
                let html = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(0, 212, 255, 0.1); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Total Exposure ${currentStrategyFilter !== 'all' ? `(${currentStrategyFilter})` : ''}</div>
                                <div style="color: var(--color-accent); font-size: 1.5rem; font-weight: 600;">$${filteredSummary.total_exposure_usd.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Total P&L ${currentStrategyFilter !== 'all' ? `(${currentStrategyFilter})` : ''}</div>
                                <div style="color: ${filteredSummary.total_pnl_usd >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}; font-size: 1.5rem; font-weight: 600;">${filteredSummary.total_pnl_usd >= 0 ? '+' : '-'}$${Math.abs(filteredSummary.total_pnl_usd).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Live / Paper ${currentStrategyFilter !== 'all' ? `(${currentStrategyFilter})` : ''}</div>
                                <div style="font-size: 1.5rem; font-weight: 600;">${filteredSummary.live_trades} / ${filteredSummary.paper_trades}</div>
                            </div>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>Entry</th>
                                <th>Source</th>
                                <th>Current P&L</th>
                                <th>P&L $</th>
                                <th>Exposure</th>
                                <th>Duration</th>
                                <th>TP Progress</th>
                                <th>Mode</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                filteredTrades.forEach(trade => {
                    const tpProgress = [
                        trade.tp1_hit ? '✓TP1' : 'TP1',
                        trade.tp2_hit ? '✓TP2' : 'TP2',
                        trade.tp3_hit ? '✓TP3' : 'TP3'
                    ].join(' ');

                    // Generate milestone HTML
                    let milestoneHtml = '';
                    if (trade.milestones && trade.status === 'active') {
                        const m = trade.milestones;
                        const uniqueId = `milestone-${trade.id}`;

                        // Build reached milestones
                        let reachedHtml = '';
                        if (m.reached && m.reached.length > 0) {
                            reachedHtml = m.reached.map(milestone => {
                                const timeAgo = milestone.minutes_ago < 1 ? 'just now' :
                                                milestone.minutes_ago === 1 ? '1 min ago' :
                                                milestone.minutes_ago < 60 ? `${milestone.minutes_ago} mins ago` :
                                                `${Math.floor(milestone.minutes_ago / 60)}h ${milestone.minutes_ago % 60}m ago`;
                                const tpBadge = milestone.is_tp ? `<span class="milestone-tp-badge">${milestone.tp_level}</span>` : '';
                                return `
                                    <div class="milestone-item milestone-reached">
                                        <span class="milestone-icon">✅</span>
                                        <span class="milestone-label">${milestone.label}${tpBadge}</span>
                                        <span class="milestone-time">${timeAgo}</span>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            reachedHtml = '<div class="milestone-item" style="color: var(--text-secondary); font-style: italic;">No milestones reached yet</div>';
                        }

                        // Build pending milestones (show next 3)
                        let pendingHtml = '';
                        if (m.pending && m.pending.length > 0) {
                            const nextThree = m.pending.slice(0, 3);
                            pendingHtml = nextThree.map(milestone => {
                                const tpBadge = milestone.is_tp ? `<span class="milestone-tp-badge">${milestone.tp_level}</span>` : '';
                                const distance = milestone.distance ? `${milestone.distance.toFixed(2)}% away` : '';
                                return `
                                    <div class="milestone-item milestone-pending">
                                        <span class="milestone-icon">⏳</span>
                                        <span class="milestone-label">${milestone.label}${tpBadge}</span>
                                        <span class="milestone-distance">${distance}</span>
                                    </div>
                                `;
                            }).join('');
                        }

                        // Build safety status
                        let safetyClass = 'safety-status';
                        let safetyIcon = '✅';
                        let safetyText = 'No SL milestones crossed';

                        if (m.sl_status && m.sl_status.crossed) {
                            safetyClass += ' danger';
                            safetyIcon = '❌';
                            safetyText = 'SL milestones crossed!';
                        } else if (m.sl_status && m.sl_status.current_drawdown < -0.3) {
                            safetyClass += ' warning';
                            safetyIcon = '⚠️';
                            safetyText = 'Approaching SL levels';
                        }

                        const slLevel = m.sl_status && m.sl_status.sl_level ? m.sl_status.sl_level.toFixed(2) : '--';
                        const maxDrawdown = m.sl_status && m.sl_status.current_drawdown ? m.sl_status.current_drawdown.toFixed(2) : '0.00';
                        const distanceToSL = m.sl_status && m.sl_status.sl_level ?
                            Math.abs(m.sl_status.current_drawdown - m.sl_status.sl_level).toFixed(2) : '--';

                        milestoneHtml = `
                            <td colspan="10" style="padding: 0;">
                                <div class="milestone-container">
                                    <div class="milestone-header" onclick="toggleMilestone('${uniqueId}', event)">
                                        <div class="milestone-title">
                                            <span>🎯 Milestone Tracking</span>
                                            <span style="font-size: 0.75rem; font-weight: 400;">(${m.reached ? m.reached.length : 0} reached, ${m.pending ? m.pending.length : 0} pending)</span>
                                        </div>
                                        <span class="milestone-toggle" id="${uniqueId}-toggle">▼ Show</span>
                                    </div>
                                    <div class="milestone-content" id="${uniqueId}-content">
                                        <div class="milestone-section">
                                            <div class="milestone-section-title">Milestones Reached</div>
                                            <div class="milestone-list">
                                                ${reachedHtml}
                                            </div>
                                        </div>
                                        ${pendingHtml ? `
                                        <div class="milestone-section">
                                            <div class="milestone-section-title">Next Milestones</div>
                                            <div class="milestone-list">
                                                ${pendingHtml}
                                            </div>
                                        </div>
                                        ` : ''}
                                        <div class="milestone-section">
                                            <div class="milestone-section-title">Safety Status</div>
                                            <div class="${safetyClass}">
                                                <div class="safety-item">
                                                    <span class="safety-icon">${safetyIcon}</span>
                                                    <span>${safetyText}</span>
                                                </div>
                                                <div class="safety-item">
                                                    <span class="safety-icon">📉</span>
                                                    <span>Max drawdown: ${maxDrawdown}% (SL at ${slLevel}%)</span>
                                                </div>
                                                <div class="safety-item">
                                                    <span class="safety-icon">📏</span>
                                                    <span>Distance to SL: ${distanceToSL}% away</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `;
                    }

                    html += `
                        <tr class="clickable-row" onclick="openTradeDetailsModal(${trade.id})" title="Click for details">
                            <td><strong>${trade.symbol}</strong></td>
                            <td><span class="badge ${trade.direction.toLowerCase()}">${trade.direction}</span></td>
                            <td>$${trade.entry_price.toFixed(trade.entry_price > 1 ? 2 : 6)}</td>
                            <td><span class="badge info">${trade.webhook_source || 'unknown'}</span></td>
                            <td>${trade.risk_strategy === 'baseline' ? '<span style="color: var(--text-secondary); font-size: 0.9em;">📊 DATA</span>' : `<span class="pnl ${trade.current_pnl_pct >= 0 ? 'positive' : 'negative'}">${trade.current_pnl_pct >= 0 ? '+' : '' }${trade.current_pnl_pct.toFixed(2)}%</span>`}</td>
                            <td>${trade.risk_strategy === 'baseline' ? '<span style="color: var(--text-secondary); font-size: 0.9em;">--</span>' : `<span class="pnl ${trade.current_pnl_usd >= 0 ? 'positive' : 'negative'}">${trade.current_pnl_usd >= 0 ? '+' : '-'}$${Math.abs(trade.current_pnl_usd).toFixed(2)}</span>`}</td>
                            <td>$${trade.notional_position_usd.toFixed(2)}</td>
                            <td style="font-size: 0.85em;">${trade.duration_minutes}m</td>
                            <td style="font-size: 0.85em; color: var(--text-primary);">${tpProgress}</td>
                            <td><span class="badge ${trade.trade_mode}">${trade.trade_mode}</span></td>
                        </tr>
                        ${milestoneHtml ? `<tr>${milestoneHtml}</tr>` : ''}
                    `;
                });

                html += '</tbody></table>';
                if (contentEl) contentEl.innerHTML = html;

            } catch (error) {
                console.error('Error loading live trades:', error);
                const contentEl = document.getElementById('live-trades-content');
                if (contentEl) {
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <p>Unable to load live trading data</p>
                        </div>
                    `;
                }
            }
        }

        async function loadAIInsights() {
            try {
                const response = await fetch('/api/ai/evaluation-summary');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                // Update stats cards with safety checks
                const evalCountEl = document.getElementById('ai-eval-count');
                const avgScoreEl = document.getElementById('ai-avg-score');
                const avgConfidenceEl = document.getElementById('ai-avg-confidence');
                const redFlagsEl = document.getElementById('ai-red-flags');

                if (evalCountEl) evalCountEl.textContent = data.total_evaluations || 0;
                if (avgScoreEl) avgScoreEl.textContent = data.avg_quality_score || '--';
                if (avgConfidenceEl) avgConfidenceEl.textContent = data.avg_confidence ? (data.avg_confidence * 100).toFixed(0) + '%' : '--';
                if (redFlagsEl) redFlagsEl.textContent = data.red_flags_count || 0;

                // Render quality distribution chart
                if (data.quality_distribution && Object.values(data.quality_distribution).some(v => v > 0)) {
                    renderQualityChart(data.quality_distribution);
                }

                // Render setup types
                if (data.setup_types && Object.keys(data.setup_types).length > 0) {
                    renderSetupTypes(data.setup_types);
                }

                // Render red flags vs green lights
                if (data.top_red_flags || data.top_green_lights) {
                    renderFlagsAnalysis(data.top_red_flags, data.top_green_lights);
                }

            } catch (error) {
                console.error('Error loading AI insights:', error);
                const evalCountEl = document.getElementById('ai-eval-count');
                if (evalCountEl) evalCountEl.textContent = 'Error';
            }
        }

        function renderQualityChart(distribution) {
            const ctx = document.getElementById('ai-quality-chart');
            if (!ctx) {
                console.warn('ai-quality-chart element not found');
                return;
            }

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                return;
            }

            try {
                const labels = Object.keys(distribution);
                const data = Object.values(distribution);

                // Update existing chart if it exists
                if (charts['ai-quality']) {
                    charts['ai-quality'].data.labels = labels;
                    charts['ai-quality'].data.datasets[0].data = data;
                    charts['ai-quality'].update('none');
                    return;
                }

                // Create new chart only if it doesn't exist
                charts['ai-quality'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(distribution),
                        datasets: [{
                            label: 'Number of Setups',
                            data: Object.values(distribution),
                            backgroundColor: [
                                'rgba(255, 68, 68, 0.6)',
                                'rgba(255, 208, 0, 0.6)',
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(139, 92, 246, 0.6)',
                                'rgba(0, 255, 136, 0.6)'
                            ],
                            borderColor: [
                                'rgba(255, 68, 68, 1)',
                                'rgba(255, 208, 0, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(139, 92, 246, 1)',
                                'rgba(0, 255, 136, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Quality Score Distribution (0-10 scale)',
                                color: '#e0e0e0'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#8892b0' },
                                grid: { color: 'rgba(42, 48, 80, 0.5)' }
                            },
                            x: {
                                ticks: { color: '#8892b0' },
                                grid: { color: 'rgba(42, 48, 80, 0.5)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering quality chart:', error);
            }
        }

        function renderSetupTypes(setupTypes) {
            const container = document.getElementById('ai-setup-types-content');
            if (!container) return;

            let html = '<table class="data-table"><thead><tr><th>Setup Type</th><th>Count</th><th>Percentage</th></tr></thead><tbody>';

            const total = Object.values(setupTypes).reduce((a, b) => a + b, 0);
            const sorted = Object.entries(setupTypes).sort((a, b) => b[1] - a[1]);

            sorted.forEach(([type, count]) => {
                const pct = ((count / total) * 100).toFixed(1);
                html += `
                    <tr>
                        <td><strong>${type}</strong></td>
                        <td>${count}</td>
                        <td>${pct}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderFlagsAnalysis(redFlags, greenLights) {
            const container = document.getElementById('ai-flags-content');
            if (!container) return;

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">';

            // Red flags
            html += '<div>';
            html += '<h3 style="color: var(--color-danger); margin-bottom: 1rem;">Top Red Flags</h3>';
            if (redFlags && Object.keys(redFlags).length > 0) {
                html += '<table class="data-table"><thead><tr><th>Warning</th><th>Count</th></tr></thead><tbody>';
                Object.entries(redFlags).forEach(([flag, count]) => {
                    html += `<tr><td>${flag}</td><td><span class="badge short">${count}</span></td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += '<p style="color: var(--text-secondary);">No red flags detected</p>';
            }
            html += '</div>';

            // Green lights
            html += '<div>';
            html += '<h3 style="color: var(--color-success); margin-bottom: 1rem;">Top Green Lights</h3>';
            if (greenLights && Object.keys(greenLights).length > 0) {
                html += '<table class="data-table"><thead><tr><th>Strength</th><th>Count</th></tr></thead><tbody>';
                Object.entries(greenLights).forEach(([light, count]) => {
                    html += `<tr><td>${light}</td><td><span class="badge long">${count}</span></td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += '<p style="color: var(--text-secondary);">No green lights detected</p>';
            }
            html += '</div>';

            html += '</div>';
            container.innerHTML = html;
        }

        async function loadLearningStats() {
            try {
                // Load all learning data in parallel with error handling
                const [learnedLevels, baselineProgress, circuitBreakers, rrHistory] = await Promise.all([
                    fetch('/api/learning/learned-levels')
                        .then(r => r.ok ? r.json() : Promise.reject(`API error: ${r.status}`))
                        .catch(err => {
                            console.error('Error loading learned levels:', err);
                            return { symbols: [] };
                        }),
                    fetch('/api/learning/baseline-progress')
                        .then(r => r.ok ? r.json() : Promise.reject(`API error: ${r.status}`))
                        .catch(err => {
                            console.error('Error loading baseline progress:', err);
                            return { symbols: [], summary: { ready_for_learning: 0, baseline_active: 0 } };
                        }),
                    fetch('/api/learning/circuit-breakers')
                        .then(r => r.ok ? r.json() : Promise.reject(`API error: ${r.status}`))
                        .catch(err => {
                            console.error('Error loading circuit breakers:', err);
                            return { assets: [], summary: { live_trading: 0, paper_trading: 0 } };
                        }),
                    fetch('/api/learning/risk-reward-history?limit=30')
                        .then(r => r.ok ? r.json() : Promise.reject(`API error: ${r.status}`))
                        .catch(err => {
                            console.error('Error loading R/R history:', err);
                            return { data: [], current_rr: 0, status: 'unknown' };
                        })
                ]);

                // Render learned levels
                renderLearnedLevels(learnedLevels);

                // Render baseline progress
                renderBaselineProgress(baselineProgress);

                // Render circuit breakers
                renderCircuitBreakers(circuitBreakers);

                // Render risk/reward chart
                renderRiskRewardChart(rrHistory);

            } catch (error) {
                console.error('Error loading learning stats:', error);
            }
        }

        function renderLearnedLevels(data) {
            const container = document.getElementById('learned-levels-content');
            const summary = document.getElementById('learned-summary');

            if (!container) {
                console.warn('learned-levels-content element not found');
                return;
            }

            if (!data || !data.symbols || data.symbols.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📊</div><p>No learned levels yet - collect 10+ trades per symbol</p></div>';
                if (summary) summary.textContent = 'No data yet';
                return;
            }

            if (summary) summary.textContent = `${data.symbols.length} symbols with learned levels`;

            let html = '<table class="data-table"><thead><tr><th>Symbol</th><th>Sample Size</th><th>Confidence</th><th>TP1</th><th>TP2</th><th>TP3</th><th>SL</th><th>Hit Rates</th></tr></thead><tbody>';

            data.symbols.forEach(s => {
                const levels = s.learned_levels || {};
                const hitRates = s.hit_rates || {};

                html += `
                    <tr>
                        <td><strong>${s.symbol || 'Unknown'}</strong></td>
                        <td>${s.sample_size || 0}</td>
                        <td><span class="badge ${s.confidence === 'high' ? 'long' : s.confidence === 'medium' ? 'paper' : 'short'}">${s.confidence || 'low'}</span></td>
                        <td>${levels.tp1_pct ? levels.tp1_pct.toFixed(2) + '%' : '--'}</td>
                        <td>${levels.tp2_pct ? levels.tp2_pct.toFixed(2) + '%' : '--'}</td>
                        <td>${levels.tp3_pct ? levels.tp3_pct.toFixed(2) + '%' : '--'}</td>
                        <td>${levels.sl_pct ? levels.sl_pct.toFixed(2) + '%' : '--'}</td>
                        <td style="font-size: 0.85em;">
                            TP1: ${hitRates.tp1 ? (hitRates.tp1 * 100).toFixed(0) + '%' : '--'} |
                            TP2: ${hitRates.tp2 ? (hitRates.tp2 * 100).toFixed(0) + '%' : '--'} |
                            TP3: ${hitRates.tp3 ? (hitRates.tp3 * 100).toFixed(0) + '%' : '--'}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderBaselineProgress(data) {
            const container = document.getElementById('baseline-content');

            if (!container) {
                console.warn('baseline-content element not found');
                return;
            }

            if (!data || !data.symbols || data.symbols.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📈</div><p>No symbols being tracked yet</p></div>';
                return;
            }

            const summary = data.summary || { ready_for_learning: 0, baseline_active: 0 };

            let html = '<div style="margin-bottom: 1.5rem;">';
            html += `<p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Baseline mode: First 10 trades per direction collect pure data (24h timeout only, no TP/SL)</p>`;
            html += `<p style="color: var(--color-accent);">✓ ${summary.ready_for_learning} symbols ready for learned levels | 📊 ${summary.baseline_active} symbols in baseline mode</p>`;
            html += '</div>';

            html += '<table class="data-table"><thead><tr><th>Symbol</th><th>LONG Progress</th><th>SHORT Progress</th><th>Total</th><th>Status</th></tr></thead><tbody>';

            data.symbols.forEach(s => {
                const longs = s.longs || { progress_pct: 0, completed: 0 };
                const shorts = s.shorts || { progress_pct: 0, completed: 0 };
                const longPct = (longs.progress_pct || 0).toFixed(0);
                const shortPct = (shorts.progress_pct || 0).toFixed(0);

                html += `
                    <tr>
                        <td><strong>${s.symbol || 'Unknown'}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px;">
                                    <div style="background: var(--color-success); height: 100%; width: ${longPct}%; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 0.85em; color: var(--text-secondary);">${longs.completed || 0}/10</span>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px;">
                                    <div style="background: var(--color-danger); height: 100%; width: ${shortPct}%; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 0.85em; color: var(--text-secondary);">${shorts.completed || 0}/10</span>
                            </div>
                        </td>
                        <td>${s.total_completed || 0}</td>
                        <td><span class="badge ${s.overall_status === 'learning' ? 'long' : 'baseline'}">${s.overall_status || 'baseline'}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderCircuitBreakers(data) {
            const container = document.getElementById('circuit-breaker-content');

            if (!container) {
                console.warn('circuit-breaker-content element not found');
                return;
            }

            if (!data || !data.assets || data.assets.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">🔌</div><p>No circuit breaker data yet (need 10+ trades)</p></div>';
                return;
            }

            const summary = data.summary || { live_trading: 0, paper_trading: 0 };

            let html = '<div style="margin-bottom: 1.5rem;">';
            html += `<p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Circuit breaker activates when R/R < 1.0 after 10+ trades</p>`;
            html += `<p style="color: var(--color-accent);">💰 ${summary.live_trading} assets in live trading | 📄 ${summary.paper_trading} assets in paper mode</p>`;
            html += '</div>';

            html += '<table class="data-table"><thead><tr><th>Symbol</th><th>Mode</th><th>Cumulative R/R</th><th>Wins/Losses</th><th>Profit Needed</th><th>Paper Count</th><th>Status</th></tr></thead><tbody>';

            data.assets.forEach(a => {
                const statusClass = a.status === 'healthy' ? 'long' : a.status === 'ok' ? 'paper' : a.status === 'warning' ? 'short' : 'baseline';
                const cumulativeRr = a.cumulative_rr || 0;
                const cumulativeWins = a.cumulative_wins || 0;
                const cumulativeLosses = a.cumulative_losses || 0;
                const profitNeeded = a.profit_needed_to_resume || 0;

                html += `
                    <tr>
                        <td><strong>${a.symbol || 'Unknown'}</strong></td>
                        <td><span class="badge ${a.trading_mode === 'live' ? 'live' : 'paper'}">${a.trading_mode || 'paper'}</span></td>
                        <td><span class="pnl ${cumulativeRr >= 1.0 ? 'positive' : 'negative'}">${cumulativeRr.toFixed(4)}</span></td>
                        <td style="font-size: 0.85em;">
                            <span class="pnl positive">+$${cumulativeWins.toFixed(2)}</span> /
                            <span class="pnl negative">-$${cumulativeLosses.toFixed(2)}</span>
                        </td>
                        <td>${profitNeeded > 0 ? '$' + profitNeeded.toFixed(2) : '--'}</td>
                        <td>${a.paper_trade_count || 0}</td>
                        <td><span class="badge ${statusClass}">${a.status || 'unknown'}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderRiskRewardChart(data) {
            const container = document.getElementById('rr-content');

            if (!container) {
                console.warn('rr-content element not found');
                return;
            }

            if (!data || !data.data || data.data.length === 0) {
                if (charts['rr-chart']) {
                    charts['rr-chart'].destroy();
                    delete charts['rr-chart'];
                }
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📊</div><p>No R/R history yet - complete at least 10 trades</p></div>';
                return;
            }

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">⚠️</div><p>Chart library not loaded</p></div>';
                return;
            }

            // Prepare chart data
            const labels = data.data.map((d, i) => `Trade ${i + 1}`);
            const rrData = data.data.map(d => d.cumulative_rr);
            const pointColors = rrData.map(r => r >= 1.0 ? 'rgba(0, 255, 136, 1)' : 'rgba(255, 68, 68, 1)');

            try {
                // Update existing chart if it exists
                if (charts['rr-chart']) {
                    charts['rr-chart'].data.labels = labels;
                    charts['rr-chart'].data.datasets[0].data = rrData;
                    charts['rr-chart'].data.datasets[0].pointBackgroundColor = pointColors;
                    charts['rr-chart'].options.plugins.title.text = `Current R/R: ${data.current_rr.toFixed(4)} (${data.status === 'healthy' ? 'Healthy ✓' : 'Warning ⚠️'})`;
                    charts['rr-chart'].options.plugins.title.color = data.status === 'healthy' ? '#00ff88' : '#ff4444';
                    charts['rr-chart'].update('none');
                    return;
                }

                // Create canvas for chart if it doesn't exist
                if (!document.getElementById('rr-chart')) {
                    container.innerHTML = '<div class="chart-container"><canvas id="rr-chart"></canvas></div>';
                }
                const ctx = document.getElementById('rr-chart');
                if (!ctx) return;

                // Create new chart only if it doesn't exist
                charts['rr-chart'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cumulative R/R',
                            data: rrData,
                            borderColor: 'rgba(0, 212, 255, 1)',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: rrData.map(r => r >= 1.0 ? 'rgba(0, 255, 136, 1)' : 'rgba(255, 68, 68, 1)'),
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `Current R/R: ${data.current_rr.toFixed(4)} (${data.status === 'healthy' ? 'Healthy ✓' : 'Warning ⚠️'})`,
                                color: data.status === 'healthy' ? '#00ff88' : '#ff4444',
                                font: { size: 16, weight: 'bold' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = data.data[context.dataIndex];
                                        return [
                                            `R/R: ${point.cumulative_rr.toFixed(4)}`,
                                            `Wins: $${point.cumulative_wins.toFixed(2)}`,
                                            `Losses: $${point.cumulative_losses.toFixed(2)}`,
                                            `Outcome: ${point.final_outcome}`,
                                            `PnL: ${point.final_pnl_pct >= 0 ? '+' : ''}${point.final_pnl_pct.toFixed(2)}%`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: { color: '#8892b0' },
                                grid: { color: 'rgba(42, 48, 80, 0.5)' },
                                title: {
                                    display: true,
                                    text: 'Risk/Reward Ratio',
                                    color: '#e0e0e0'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#8892b0',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { color: 'rgba(42, 48, 80, 0.5)' }
                            }
                        },
                        // Add horizontal line at R/R = 1.0
                        annotation: {
                            annotations: [{
                                type: 'line',
                                yMin: 1.0,
                                yMax: 1.0,
                                borderColor: 'rgba(255, 208, 0, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Break Even (R/R = 1.0)',
                                    enabled: true,
                                    position: 'end'
                                }
                            }]
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering R/R chart:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">⚠️</div><p>Error rendering chart</p></div>';
            }
        }

        // =====================================================================
        // Strategy Analysis Tab
        // =====================================================================
        async function loadStrategyAnalysis() {
            try {
                // Update timestamp
                const timestampEl = document.getElementById('strategy-last-updated');
                if (timestampEl) {
                    timestampEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                }

                // Fetch portfolio simulation data
                const response = await fetch('/api/strategies/portfolio-simulation');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                // Render strategy performance cards
                renderStrategyCards(data);

                // Render strategy comparison table
                renderStrategyComparison(data);

            } catch (error) {
                console.error('Error loading strategy analysis:', error);
                const cardsGrid = document.getElementById('strategy-cards-grid');
                if (cardsGrid) {
                    cardsGrid.innerHTML = '<div class="stat-card"><div class="stat-label">Error</div><div class="stat-value error">Failed to load strategy data</div></div>';
                }
            }
        }

        function renderStrategyCards(data) {
            const cardsGrid = document.getElementById('strategy-cards-grid');
            if (!cardsGrid) return;

            if (!data.strategies || Object.keys(data.strategies).length === 0) {
                cardsGrid.innerHTML = '<div class="stat-card"><div class="stat-label">No Data</div><div class="stat-value">No strategy performance data available</div></div>';
                return;
            }

            const strategies = data.strategies;
            const bestStrategy = data.best_strategy;

            // Convert strategies object to sorted array
            const strategyArray = Object.entries(strategies).map(([name, stats]) => ({
                name,
                ...stats
            })).sort((a, b) => b.total_return_pct - a.total_return_pct);

            let cardsHtml = '';

            // Best Strategy Card
            if (bestStrategy && strategies[bestStrategy]) {
                const best = strategies[bestStrategy];
                cardsHtml += `
                    <div class="stat-card" style="border: 2px solid var(--color-success);">
                        <div class="stat-label">🏆 Best Strategy</div>
                        <div class="stat-value" style="font-size: 1.5rem;">${bestStrategy}</div>
                        <div style="margin-top: 0.5rem; color: var(--color-success); font-size: 1.2rem; font-weight: 600;">
                            ${best.total_return_pct >= 0 ? '+' : ''}${best.total_return_pct.toFixed(2)}%
                        </div>
                        <div style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">
                            ${best.total_trades} trades • ${best.win_rate.toFixed(1)}% WR
                        </div>
                    </div>
                `;
            }

            // Summary Card
            cardsHtml += `
                <div class="stat-card">
                    <div class="stat-label">Total Trades Analyzed</div>
                    <div class="stat-value">${data.summary?.total_unique_trades || 0}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                        ${data.summary?.strategies_compared || 0} strategies compared
                    </div>
                </div>
            `;

            // Portfolio Starting Capital Card
            if (data.filters) {
                cardsHtml += `
                    <div class="stat-card">
                        <div class="stat-label">Portfolio Size</div>
                        <div class="stat-value">$${data.filters.starting_capital.toLocaleString()}</div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                            ${data.filters.risk_pct}% risk per trade
                        </div>
                    </div>
                `;
            }

            // Average Performance Card
            const avgReturn = strategyArray.reduce((sum, s) => sum + s.total_return_pct, 0) / strategyArray.length;
            const avgWinRate = strategyArray.reduce((sum, s) => sum + s.win_rate, 0) / strategyArray.length;
            cardsHtml += `
                <div class="stat-card">
                    <div class="stat-label">Average Performance</div>
                    <div class="stat-value" style="color: ${avgReturn >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">
                        ${avgReturn >= 0 ? '+' : ''}${avgReturn.toFixed(2)}%
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                        ${avgWinRate.toFixed(1)}% avg win rate
                    </div>
                </div>
            `;

            cardsGrid.innerHTML = cardsHtml;
        }

        function renderStrategyComparison(data) {
            const container = document.getElementById('strategy-trades-list');
            if (!container) return;

            if (!data.strategies || Object.keys(data.strategies).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📊</div><p>No strategy data available</p></div>';
                return;
            }

            const strategies = data.strategies;

            // Convert to sorted array
            const strategyArray = Object.entries(strategies).map(([name, stats]) => ({
                name,
                ...stats
            })).sort((a, b) => b.total_return_pct - a.total_return_pct);

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Final Balance</th>
                            <th>Total Return</th>
                            <th>Return %</th>
                            <th>Win Rate</th>
                            <th>Wins/Losses</th>
                            <th>Max Drawdown</th>
                            <th>Win Streak</th>
                            <th>Loss Streak</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            strategyArray.forEach(strategy => {
                const returnClass = strategy.total_return_pct >= 0 ? 'profit' : 'loss';
                const isBest = strategy.name === data.best_strategy;

                html += `
                    <tr style="${isBest ? 'background: rgba(0, 255, 136, 0.1); border-left: 3px solid var(--color-success);' : ''}">
                        <td>
                            <strong>${strategy.name}</strong>
                            ${isBest ? ' 🏆' : ''}
                        </td>
                        <td>$${strategy.final_balance.toLocaleString()}</td>
                        <td class="${returnClass}">
                            ${strategy.total_return_usd >= 0 ? '+' : ''}$${strategy.total_return_usd.toLocaleString()}
                        </td>
                        <td class="${returnClass}">
                            ${strategy.total_return_pct >= 0 ? '+' : ''}${strategy.total_return_pct.toFixed(2)}%
                        </td>
                        <td>${strategy.win_rate.toFixed(1)}%</td>
                        <td>
                            <span style="color: var(--color-success);">${strategy.wins}W</span> /
                            <span style="color: var(--color-danger);">${strategy.losses}L</span>
                        </td>
                        <td style="color: var(--color-danger);">
                            ${strategy.max_drawdown_pct.toFixed(2)}%
                        </td>
                        <td style="color: var(--color-success);">
                            ${strategy.max_win_streak}
                        </td>
                        <td style="color: var(--color-danger);">
                            ${strategy.max_loss_streak}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            // Add filters info if available
            if (data.filters && (data.filters.symbol || data.filters.direction || data.filters.webhook_source)) {
                html = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(0, 212, 255, 0.1); border-radius: 8px; font-size: 0.875rem;">
                        <strong>Filters Applied:</strong>
                        ${data.filters.symbol ? `Symbol: ${data.filters.symbol} • ` : ''}
                        ${data.filters.direction ? `Direction: ${data.filters.direction} • ` : ''}
                        ${data.filters.webhook_source ? `Source: ${data.filters.webhook_source}` : ''}
                    </div>
                ` + html;
            }

            container.innerHTML = html;
        }

        // =====================================================================
        // Auto-refresh
        // =====================================================================
        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            // Initial calls
            updateLastEvent();

            refreshInterval = setInterval(() => {
                try {
                    const activeTabEl = document.querySelector('.tab.active');
                    if (activeTabEl) {
                        const activeTab = activeTabEl.getAttribute('data-tab');
                        if (activeTab) {
                            // Skip analytics auto-refresh for both analytics tab AND dashboard
                            // (dashboard now includes analytics charts that shouldn't flicker)
                            const skipAnalytics = (activeTab === 'analytics' || activeTab === 'dashboard');
                            loadTabData(activeTab, skipAnalytics);
                        }
                    }
                    updateHeaderStatus();
                    updateLastEvent();
                } catch (error) {
                    console.error('Error in auto-refresh:', error);
                }
            }, 30000); // Reduced from 5s to 30s to lower CPU usage
        }

        async function updateHeaderStatus() {
            try {
                const response = await fetch('/api/health');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const health = await response.json();

                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                const lastUpdate = document.getElementById('last-update');

                if (statusDot && statusText) {
                    if (health.status === 'healthy') {
                        statusDot.className = 'status-dot green';
                        statusText.textContent = 'System Healthy';
                    } else {
                        statusDot.className = 'status-dot yellow';
                        statusText.textContent = 'Degraded';
                    }
                }

                if (lastUpdate) {
                    lastUpdate.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                }
            } catch (error) {
                console.error('Error updating header status:', error);
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                if (statusDot) statusDot.className = 'status-dot red';
                if (statusText) statusText.textContent = 'Connection Error';
            }
        }

        // =====================================================================
        // Utility Functions
        // =====================================================================
        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ${minutes % 60}m`;
            const days = Math.floor(hours / 24);
            return `${days}d ${hours % 24}h`;
        }

        // =====================================================================
        // Modal Functions
        // =====================================================================
        async function openTradeDetailsModal(tradeId) {
            const modal = document.getElementById('trade-details-modal');
            const modalBody = document.getElementById('modal-details-body');

            if (!modal || !modalBody) return;

            // Show modal with loading state
            modal.classList.add('active');
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p>Loading trade details...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/trades/${tradeId}/details`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();

                // Render trade details
                modalBody.innerHTML = renderTradeDetails(data);
            } catch (error) {
                console.error('Error loading trade details:', error);
                modalBody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <p>Unable to load trade details</p>
                    </div>
                `;
            }
        }

        function closeTradeDetailsModal() {
            const modal = document.getElementById('trade-details-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function toggleMilestone(id, event) {
            // Stop event propagation to prevent modal from opening
            if (event) {
                event.stopPropagation();
            }

            const content = document.getElementById(`${id}-content`);
            const toggle = document.getElementById(`${id}-toggle`);

            if (content && toggle) {
                content.classList.toggle('expanded');
                if (content.classList.contains('expanded')) {
                    toggle.textContent = '▲ Hide';
                } else {
                    toggle.textContent = '▼ Show';
                }
            }
        }

        function renderTradeDetails(data) {
            const trade = data.trade;
            const aiAnalysis = data.ai_analysis;
            const symbolStats = data.symbol_stats;
            const previousTrades = data.previous_trades || [];

            // Calculate duration
            const entryTime = new Date(trade.entry_timestamp);
            const completedTime = trade.completed_at ? new Date(trade.completed_at) : new Date();
            const durationMs = completedTime - entryTime;
            const durationHours = (durationMs / (1000 * 60 * 60)).toFixed(1);

            let html = `
                <!-- Trade Overview -->
                <div class="modal-section">
                    <div class="modal-section-title">Trade Overview</div>
                    <div class="modal-grid">
                        <div class="modal-field">
                            <div class="modal-field-label">Symbol</div>
                            <div class="modal-field-value">${trade.symbol}</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Direction</div>
                            <div class="modal-field-value"><span class="badge ${trade.direction.toLowerCase()}">${trade.direction}</span></div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Entry Price</div>
                            <div class="modal-field-value">$${trade.entry_price.toFixed(trade.entry_price > 1 ? 2 : 6)}</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Status</div>
                            <div class="modal-field-value"><span class="badge ${trade.status === 'active' ? 'live' : 'baseline'}">${trade.status}</span></div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Duration</div>
                            <div class="modal-field-value">${durationHours}h</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Current P&L</div>
                            <div class="modal-field-value">
                                ${trade.risk_strategy === 'baseline'
                                    ? '<span style="color: var(--text-secondary); font-size: 0.95em;">📊 DATA COLLECTION</span>'
                                    : `<span class="pnl ${(trade.final_pnl_pct || trade.current_pnl_pct || 0) >= 0 ? 'positive' : 'negative'}">
                                    ${((trade.final_pnl_pct || trade.current_pnl_pct || 0) >= 0 ? '+' : '')}${(trade.final_pnl_pct || trade.current_pnl_pct || 0).toFixed(2)}%
                                </span>`}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade Levels -->
                <div class="modal-section">
                    <div class="modal-section-title">Trade Levels</div>
                    <div class="modal-grid">
                        <div class="modal-field">
                            <div class="modal-field-label">TP1</div>
                            <div class="modal-field-value">${trade.tp1_hit ? '✓' : '○'} ${trade.planned_tp1_pct || '--'}%</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">TP2</div>
                            <div class="modal-field-value">${trade.tp2_hit ? '✓' : '○'} ${trade.planned_tp2_pct || '--'}%</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">TP3</div>
                            <div class="modal-field-value">${trade.tp3_hit ? '✓' : '○'} ${trade.planned_tp3_pct || '--'}%</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Stop Loss</div>
                            <div class="modal-field-value">${trade.sl_hit ? '✓ HIT' : '○'} ${trade.planned_sl_pct || '--'}%</div>
                        </div>
                    </div>
                </div>
            `;

            // AI Analysis Section
            if (aiAnalysis && (aiAnalysis.reasoning || aiAnalysis.red_flags || aiAnalysis.green_lights)) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            🤖 AI Analysis
                            ${aiAnalysis.quality_score ? `<span style="float: right; font-size: 0.9em; color: var(--color-accent);">Quality Score: ${aiAnalysis.quality_score}/10</span>` : ''}
                        </div>
                        <div style="background: rgba(212, 175, 55, 0.05); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--color-accent);">
                `;

                // Quality Score Bar
                if (aiAnalysis.quality_score) {
                    const scoreWidth = (aiAnalysis.quality_score / 10) * 100;
                    const scoreColor = aiAnalysis.quality_score >= 7 ? '#10b981' : aiAnalysis.quality_score >= 5 ? '#f59e0b' : '#ef4444';
                    html += `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong style="color: var(--color-accent);">Setup Quality</strong>
                                ${aiAnalysis.confidence ? `<span style="font-size: 0.85em; color: var(--text-secondary);">Confidence: ${(aiAnalysis.confidence * 100).toFixed(0)}%</span>` : ''}
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.05); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: ${scoreColor}; height: 100%; width: ${scoreWidth}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }

                // AI Reasoning
                if (aiAnalysis.reasoning) {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                            <div style="display: flex; align-items: start; gap: 0.5rem;">
                                <span style="color: var(--color-accent); font-size: 1.2em;">💡</span>
                                <div>
                                    <strong style="color: var(--color-accent); display: block; margin-bottom: 0.5rem;">Analysis:</strong>
                                    <div style="color: var(--text-primary); line-height: 1.6;">${aiAnalysis.reasoning}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Recommended Action
                if (aiAnalysis.recommended_action) {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="display: flex; align-items: start; gap: 0.5rem;">
                                <span style="font-size: 1.2em;">🎯</span>
                                <div>
                                    <strong style="color: #10b981; display: block; margin-bottom: 0.5rem;">Recommended Action:</strong>
                                    <div style="color: var(--text-primary); line-height: 1.6;">${aiAnalysis.recommended_action}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Green Lights
                if (aiAnalysis.green_lights && Array.isArray(aiAnalysis.green_lights) && aiAnalysis.green_lights.length > 0) {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.05); border-radius: 6px;">
                            <strong style="color: #10b981; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.1em;">✅</span> Bullish Signals
                            </strong>
                            <ul style="list-style: none; padding-left: 0; margin: 0;">
                                ${aiAnalysis.green_lights.map(light => `
                                    <li style="padding: 0.5rem 0; border-bottom: 1px solid rgba(16, 185, 129, 0.1); display: flex; align-items: start; gap: 0.5rem;">
                                        <span style="color: #10b981; margin-top: 0.2rem;">•</span>
                                        <span style="color: var(--text-primary); line-height: 1.5;">${light}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Red Flags
                if (aiAnalysis.red_flags && Array.isArray(aiAnalysis.red_flags) && aiAnalysis.red_flags.length > 0) {
                    html += `
                        <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.05); border-radius: 6px;">
                            <strong style="color: #ef4444; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.1em;">⚠️</span> Risk Factors
                            </strong>
                            <ul style="list-style: none; padding-left: 0; margin: 0;">
                                ${aiAnalysis.red_flags.map(flag => `
                                    <li style="padding: 0.5rem 0; border-bottom: 1px solid rgba(239, 68, 68, 0.1); display: flex; align-items: start; gap: 0.5rem;">
                                        <span style="color: #ef4444; margin-top: 0.2rem;">•</span>
                                        <span style="color: var(--text-primary); line-height: 1.5;">${flag}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            // Symbol Statistics Section
            if (symbolStats) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Symbol Performance (${trade.symbol})</div>
                        <div class="modal-grid">
                            <div class="modal-field">
                                <div class="modal-field-label">Win Rate</div>
                                <div class="modal-field-value">${symbolStats.win_rate ? (symbolStats.win_rate * 100).toFixed(1) : '--'}%</div>
                            </div>
                            <div class="modal-field">
                                <div class="modal-field-label">Avg P&L</div>
                                <div class="modal-field-value">
                                    <span class="pnl ${symbolStats.avg_pnl >= 0 ? 'positive' : 'negative'}">
                                        ${symbolStats.avg_pnl >= 0 ? '+' : ''}${symbolStats.avg_pnl ? symbolStats.avg_pnl.toFixed(2) : '--'}%
                                    </span>
                                </div>
                            </div>
                            <div class="modal-field">
                                <div class="modal-field-label">Total Trades</div>
                                <div class="modal-field-value">${symbolStats.total_trades || '--'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Previous Trades Section
            if (previousTrades.length > 0) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Previous Trades (${trade.symbol})</div>
                        <table class="modal-trades-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Direction</th>
                                    <th>Entry</th>
                                    <th>Outcome</th>
                                    <th>P&L</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                previousTrades.forEach(prevTrade => {
                    const prevEntryTime = new Date(prevTrade.entry_timestamp);
                    const prevCompletedTime = prevTrade.completed_at ? new Date(prevTrade.completed_at) : null;
                    const prevDuration = prevCompletedTime ?
                        formatDuration(Math.floor((prevCompletedTime - prevEntryTime) / (1000 * 60))) : '--';

                    const isCompleted = prevTrade.status === 'completed' || prevTrade.completed_at;
                    html += `
                        <tr>
                            <td>${prevEntryTime.toLocaleDateString()}</td>
                            <td><span class="badge ${prevTrade.direction.toLowerCase()}">${prevTrade.direction}</span></td>
                            <td>$${prevTrade.entry_price.toFixed(prevTrade.entry_price > 1 ? 2 : 6)}</td>
                            <td><span class="badge">${prevTrade.final_outcome || 'active'}</span></td>
                            <td>
                                <span class="pnl ${(prevTrade.final_pnl_pct || 0) >= 0 ? 'positive' : 'negative'}">
                                    ${((prevTrade.final_pnl_pct || 0) >= 0 ? '+' : '')}${(prevTrade.final_pnl_pct || 0).toFixed(2)}%
                                </span>
                            </td>
                            <td>${prevDuration}</td>
                            <td>
                                ${isCompleted ? `<button class="btn-simulation" onclick="openSimulationModal(${prevTrade.id})">View Simulations</button>` : '<span style="color: var(--text-muted); font-size: 0.75rem;">N/A</span>'}
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            return html;
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('trade-details-modal');
            if (modal && e.target === modal) {
                closeTradeDetailsModal();
            }

            const simModal = document.getElementById('simulation-modal');
            if (simModal && e.target === simModal) {
                closeSimulationModal();
            }
        });

        // =====================================================================
        // Strategy Simulation Modal
        // =====================================================================
        let simulationChart = null;

        async function openSimulationModal(tradeId) {
            const modal = document.getElementById('simulation-modal');
            const modalBody = document.getElementById('simulation-modal-body');

            modal.classList.add('active');
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p>Loading simulation data...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/strategies/simulations/${tradeId}`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                renderSimulationResults(data);
            } catch (error) {
                console.error('Failed to load simulation data:', error);
                modalBody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <p>Unable to load simulation data</p>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            ${error.message}
                        </p>
                    </div>
                `;
            }
        }

        function closeSimulationModal() {
            const modal = document.getElementById('simulation-modal');
            if (modal) {
                modal.classList.remove('active');
            }

            // Destroy chart to prevent memory leaks
            if (simulationChart) {
                simulationChart.destroy();
                simulationChart = null;
            }
        }

        function renderSimulationResults(data) {
            const modalBody = document.getElementById('simulation-modal-body');
            const simulations = data.simulations || [];
            const tradeInfo = data.trade_info || {};
            const actualStrategy = tradeInfo.risk_strategy || 'baseline';

            if (simulations.length === 0) {
                modalBody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <p>No simulation data available for this trade</p>
                    </div>
                `;
                return;
            }

            // Trade info header
            let html = `
                <div class="modal-section">
                    <div class="modal-section-title">Trade Information</div>
                    <div class="modal-grid">
                        <div class="modal-field">
                            <div class="modal-field-label">Symbol</div>
                            <div class="modal-field-value">${tradeInfo.symbol || 'N/A'}</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Direction</div>
                            <div class="modal-field-value">
                                <span class="badge ${(tradeInfo.direction || '').toLowerCase()}">${tradeInfo.direction || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Entry Price</div>
                            <div class="modal-field-value">$${tradeInfo.entry_price ? tradeInfo.entry_price.toFixed(tradeInfo.entry_price > 1 ? 2 : 6) : 'N/A'}</div>
                        </div>
                        <div class="modal-field">
                            <div class="modal-field-label">Actual Strategy</div>
                            <div class="modal-field-value">
                                <span class="badge ${actualStrategy === 'baseline' ? 'baseline' : 'live'}">
                                    ${actualStrategy === 'baseline' ? 'Baseline' : actualStrategy.replace('strategy_', 'Strategy ').toUpperCase()}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bar Chart -->
                <div class="modal-section">
                    <div class="modal-section-title">Simulated P&L Comparison</div>
                    <div class="simulation-chart-container">
                        <canvas id="simulation-chart"></canvas>
                    </div>
                </div>

                <!-- Table -->
                <div class="modal-section">
                    <div class="modal-section-title">Detailed Results</div>
                    <table class="simulation-table">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Exit Reason</th>
                                <th>P&L %</th>
                                <th>Duration (min)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Sort simulations by strategy name
            const sortedSimulations = simulations.sort((a, b) =>
                a.strategy_name.localeCompare(b.strategy_name)
            );

            sortedSimulations.forEach(sim => {
                const isActualStrategy = actualStrategy !== 'baseline' && sim.strategy_name === actualStrategy;
                const strategyLetter = sim.strategy_name.replace('strategy_', '').toLowerCase();
                const strategyLabel = sim.strategy_name.replace('strategy_', 'Strategy ').toUpperCase();
                const pnlClass = (sim.simulated_pnl_pct || 0) >= 0 ? 'positive' : 'negative';

                html += `
                    <tr class="${isActualStrategy ? 'active-strategy' : ''}">
                        <td>
                            <span class="strategy-label strategy-${strategyLetter}-label">
                                ${strategyLabel}
                            </span>
                            ${isActualStrategy ? ' <span style="color: var(--color-accent); font-size: 0.75rem;">⭐ ACTUAL</span>' : ''}
                        </td>
                        <td>${sim.exit_reason || 'N/A'}</td>
                        <td>
                            <span class="pnl ${pnlClass}">
                                ${((sim.simulated_pnl_pct || 0) >= 0 ? '+' : '')}${(sim.simulated_pnl_pct || 0).toFixed(2)}%
                            </span>
                        </td>
                        <td>${sim.duration_minutes || 'N/A'}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            modalBody.innerHTML = html;

            // Render chart after DOM is updated
            setTimeout(() => renderSimulationChart(sortedSimulations, actualStrategy), 0);
        }

        function renderSimulationChart(simulations, actualStrategy) {
            const canvas = document.getElementById('simulation-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (simulationChart) {
                simulationChart.destroy();
            }

            const strategyColors = {
                'strategy_A': '#3b82f6',
                'strategy_B': '#8b5cf6',
                'strategy_C': '#10b981',
                'strategy_D': '#f59e0b'
            };

            const labels = simulations.map(s => s.strategy_name.replace('strategy_', 'Strategy '));
            const data = simulations.map(s => s.simulated_pnl_pct || 0);
            const backgroundColors = simulations.map(s => {
                const color = strategyColors[s.strategy_name] || '#6b7280';
                const isActual = actualStrategy !== 'baseline' && s.strategy_name === actualStrategy;
                return isActual ? color : color + '80'; // Add transparency for non-actual strategies
            });
            const borderColors = simulations.map(s => strategyColors[s.strategy_name] || '#6b7280');
            const borderWidths = simulations.map(s => {
                const isActual = actualStrategy !== 'baseline' && s.strategy_name === actualStrategy;
                return isActual ? 3 : 2;
            });

            simulationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Simulated P&L %',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: borderWidths
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const sim = simulations[context.dataIndex];
                                    return [
                                        `P&L: ${value >= 0 ? '+' : ''}${value.toFixed(2)}%`,
                                        `Exit: ${sim.exit_reason || 'N/A'}`,
                                        `Duration: ${sim.duration_minutes || 'N/A'} min`
                                    ];
                                }
                            },
                            backgroundColor: 'rgba(15, 23, 41, 0.95)',
                            titleColor: '#D4AF37',
                            bodyColor: '#e0e0e0',
                            borderColor: '#2a3050',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(42, 48, 80, 0.5)'
                            },
                            ticks: {
                                color: '#8892b0',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#8892b0'
                            }
                        }
                    }
                }
            });
        }
    </script>

    <!-- Trade Details Modal -->
    <div id="trade-details-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">Trade Details</div>
                <button class="modal-close" onclick="closeTradeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-details-body">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Strategy Simulation Modal -->
    <div id="simulation-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">Strategy Simulations - What-If Analysis</div>
                <button class="modal-close" onclick="closeSimulationModal()">&times;</button>
            </div>
            <div class="modal-body" id="simulation-modal-body">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Regeneration Modal -->
    <div id="regen-modal" class="regen-modal">
        <div class="regen-modal-content">
            <div class="regen-modal-header">Force Strategy Regeneration</div>
            <div class="regen-modal-body">
                <p>Select a symbol to regenerate strategies for:</p>
                <select id="regen-symbol-select" class="regen-symbol-select">
                    <option value="">Select symbol...</option>
                </select>
                <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--color-warning);">
                    ⚠️ This will immediately regenerate strategies A/B/C/D based on the last 20 completed trades,
                    regardless of the current baseline completion count.
                </p>
            </div>
            <div class="regen-modal-footer">
                <button class="regen-modal-btn cancel" onclick="closeRegenerationDialog()">Cancel</button>
                <button class="regen-modal-btn confirm" onclick="confirmRegeneration()">Regenerate Now</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Mobile-only: Floating refresh button -->
    <button class="mobile-refresh-btn" id="mobile-refresh-btn" aria-label="Refresh dashboard" style="display: none;">
        ⟳
    </button>

    <script>
        // Show refresh button only on mobile
        if (window.innerWidth <= 768) {
            document.getElementById('mobile-refresh-btn').style.display = 'flex';
        }

        // Mobile refresh button functionality
        document.getElementById('mobile-refresh-btn')?.addEventListener('click', function() {
            this.classList.add('refreshing');

            // Trigger data refresh
            if (typeof refreshAllData === 'function') {
                refreshAllData();
            }

            // Remove spinner after 1 second
            setTimeout(() => {
                this.classList.remove('refreshing');
            }, 1000);
        });

        // Re-check on resize
        window.addEventListener('resize', function() {
            const btn = document.getElementById('mobile-refresh-btn');
            if (btn) {
                btn.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
            }
        });
    </script>
</body>
</html>
