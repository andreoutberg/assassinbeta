<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Comparison Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .last-updated {
            color: #666;
            font-size: 14px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .card.expanded {
            grid-column: 1 / -1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .expand-icon {
            font-size: 24px;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .card-subtitle {
            color: #666;
            font-size: 14px;
        }

        .card-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .card.expanded .card-details {
            display: block;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge.winner {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.no-data {
            background: #fee2e2;
            color: #991b1b;
        }

        .recent-trades {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .recent-trades h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .trade-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #667eea;
        }

        .trade-row:hover {
            background: #e9ecef;
        }

        .trade-row.expanded {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-symbol {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .trade-pnl {
            font-size: 18px;
            font-weight: bold;
        }

        .trade-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .trade-row.expanded .trade-details {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Strategy Comparison Dashboard</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
            <button class="refresh-btn" onclick="loadDashboard()">Refresh Data</button>
        </div>

        <!-- Top Performance Cards -->
        <div class="cards-grid" id="cardsGrid">
            <div class="card loading">Loading dashboard data...</div>
        </div>

        <!-- Recent Trades -->
        <div class="recent-trades">
            <h2>Recent Completed Trades</h2>
            <div id="recentTrades" class="loading">Loading recent trades...</div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let recentTradesData = null;
        let lastUpdate = null;

        async function loadDashboard() {
            try {
                // Load overview data
                const overviewResponse = await fetch('/api/strategies/dashboard-overview');
                dashboardData = await overviewResponse.json();
                
                // Load recent trades
                const tradesResponse = await fetch('/api/strategies/recent-trades-overview?limit=20');
                const tradesJson = await tradesResponse.json();
                recentTradesData = tradesJson.trades;
                
                lastUpdate = new Date();
                document.getElementById('lastUpdated').textContent = `Last updated: ${formatTime(lastUpdate)}`;
                
                renderCards();
                renderRecentTrades();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('cardsGrid').innerHTML = '<div class="card">Error loading data. Please try again.</div>';
            }
        }

        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            const cards = [];

            // Best Strategy Card
            if (dashboardData.best_strategy) {
                const strat = dashboardData.best_strategy;
                cards.push(`
                    <div class="card" onclick="toggleCard(this)">
                        <div class="card-header">
                            <div class="card-title">Best Strategy</div>
                            <div class="expand-icon">â†“</div>
                        </div>
                        <div class="card-value">${strat.name}</div>
                        <div class="card-subtitle">${strat.symbol} ${strat.direction}</div>
                        <div class="card-subtitle">Avg PnL: <span class="${strat.avg_pnl > 0 ? 'positive' : 'negative'}">${strat.avg_pnl.toFixed(2)}%</span></div>
                        <div class="card-details">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Win Rate</div>
                                    <div class="detail-value">${strat.win_rate.toFixed(1)}%</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Trades Analyzed</div>
                                    <div class="detail-value">${strat.trades}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Avg PnL</div>
                                    <div class="detail-value ${strat.avg_pnl > 0 ? 'positive' : 'negative'}">${strat.avg_pnl.toFixed(2)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }

            // Best Asset Card
            if (dashboardData.best_asset) {
                const asset = dashboardData.best_asset;
                cards.push(`
                    <div class="card" onclick="toggleCard(this)">
                        <div class="card-header">
                            <div class="card-title">Best Asset</div>
                            <div class="expand-icon">â†“</div>
                        </div>
                        <div class="card-value">${asset.symbol}</div>
                        <div class="card-subtitle">${asset.direction}</div>
                        <div class="card-subtitle">Total PnL: <span class="${asset.total_pnl > 0 ? 'positive' : 'negative'}">${asset.total_pnl.toFixed(2)}%</span></div>
                        <div class="card-details">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Total PnL</div>
                                    <div class="detail-value ${asset.total_pnl > 0 ? 'positive' : 'negative'}">${asset.total_pnl.toFixed(2)}%</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Trades</div>
                                    <div class="detail-value">${asset.trades}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Avg per Trade</div>
                                    <div class="detail-value ${asset.total_pnl > 0 ? 'positive' : 'negative'}">${(asset.total_pnl / asset.trades).toFixed(2)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }

            // Best Source Card
            if (dashboardData.best_source) {
                const source = dashboardData.best_source;
                cards.push(`
                    <div class="card" onclick="toggleCard(this)">
                        <div class="card-header">
                            <div class="card-title">Best Webhook Source</div>
                            <div class="expand-icon">â†“</div>
                        </div>
                        <div class="card-value">${source.source}</div>
                        <div class="card-subtitle">Total PnL: <span class="${source.total_pnl > 0 ? 'positive' : 'negative'}">${source.total_pnl.toFixed(2)}%</span></div>
                        <div class="card-details">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Total PnL</div>
                                    <div class="detail-value ${source.total_pnl > 0 ? 'positive' : 'negative'}">${source.total_pnl.toFixed(2)}%</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Trades</div>
                                    <div class="detail-value">${source.trades}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Avg per Trade</div>
                                    <div class="detail-value ${source.total_pnl > 0 ? 'positive' : 'negative'}">${(source.total_pnl / source.trades).toFixed(2)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            }

            // Breakeven A/B Test Card
            const breakevenTests = Object.values(dashboardData.breakeven_test || {});
            if (breakevenTests.length > 0) {
                const testHtml = breakevenTests.map(test => {
                    if (test.strategy_a_pnl !== undefined) {
                        // A vs E test
                        return `
                            <div class="detail-item">
                                <div class="detail-label">${test.asset} - A vs E</div>
                                <div class="detail-value">
                                    A: <span class="${test.strategy_a_pnl > 0 ? 'positive' : 'negative'}">${test.strategy_a_pnl.toFixed(2)}%</span><br>
                                    E: <span class="${test.strategy_e_pnl > 0 ? 'positive' : 'negative'}">${test.strategy_e_pnl.toFixed(2)}%</span>
                                    <span class="badge winner">${test.winner} Wins</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // C vs F test
                        return `
                            <div class="detail-item">
                                <div class="detail-label">${test.asset} - C vs F</div>
                                <div class="detail-value">
                                    C: <span class="${test.strategy_c_pnl > 0 ? 'positive' : 'negative'}">${test.strategy_c_pnl.toFixed(2)}%</span><br>
                                    F: <span class="${test.strategy_f_pnl > 0 ? 'positive' : 'negative'}">${test.strategy_f_pnl.toFixed(2)}%</span>
                                    <span class="badge winner">${test.winner} Wins</span>
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                cards.push(`
                    <div class="card" onclick="toggleCard(this)">
                        <div class="card-header">
                            <div class="card-title">Breakeven A/B Test</div>
                            <div class="expand-icon">â†“</div>
                        </div>
                        <div class="card-value">${breakevenTests.length}</div>
                        <div class="card-subtitle">Active Comparisons</div>
                        <div class="card-details">
                            <div class="detail-grid">
                                ${testHtml}
                            </div>
                        </div>
                    </div>
                `);
            } else {
                cards.push(`
                    <div class="card" onclick="toggleCard(this)">
                        <div class="card-header">
                            <div class="card-title">Breakeven A/B Test</div>
                            <div class="expand-icon">â†“</div>
                        </div>
                        <div class="card-value">-</div>
                        <div class="card-subtitle">No data yet <span class="badge no-data">Pending trades</span></div>
                        <div class="card-details">
                            <p>Strategy E/F will be tested against A/C once breakeven strategies complete their first trades. Data will automatically populate here.</p>
                        </div>
                    </div>
                `);
            }

            grid.innerHTML = cards.join('');
        }

        function renderRecentTrades() {
            const container = document.getElementById('recentTrades');
            
            if (!recentTradesData || recentTradesData.length === 0) {
                container.innerHTML = '<p>No recent trades found.</p>';
                return;
            }

            const tradesHtml = recentTradesData.map(trade => `
                <div class="trade-row" onclick="toggleTrade(this, ${trade.id})">
                    <div class="trade-header">
                        <div>
                            <span class="trade-symbol">${trade.symbol} ${trade.direction}</span>
                            <span style="color: #666; font-size: 14px; margin-left: 10px;">${trade.trade_identifier || `#${trade.id}`}</span>
                        </div>
                        <div class="trade-pnl ${trade.final_pnl_pct > 0 ? 'positive' : 'negative'}">
                            ${trade.final_pnl_pct.toFixed(2)}%
                        </div>
                    </div>
                    <div class="trade-details" id="trade-details-${trade.id}">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Entry Price</div>
                                <div class="detail-value">$${trade.entry_price.toFixed(4)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Max Profit</div>
                                <div class="detail-value positive">${trade.max_profit_pct.toFixed(2)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Max Drawdown</div>
                                <div class="detail-value negative">${trade.max_drawdown_pct.toFixed(2)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Completed</div>
                                <div class="detail-value" style="font-size: 14px;">${formatDateTime(trade.completed_at)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; color: #666; font-size: 14px;">
                            ðŸ’¡ Strategy comparison data will load here (showing what each strategy A-F would have done)
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = tradesHtml;
        }

        function toggleCard(card) {
            const wasExpanded = card.classList.contains('expanded');
            
            // Collapse all cards
            document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
            
            // Expand clicked card if it wasn't already expanded
            if (!wasExpanded) {
                card.classList.add('expanded');
            }
        }

        function toggleTrade(row, tradeId) {
            const wasExpanded = row.classList.contains('expanded');
            
            // Collapse all trades
            document.querySelectorAll('.trade-row').forEach(r => r.classList.remove('expanded'));
            
            // Expand clicked trade if it wasn't already expanded
            if (!wasExpanded) {
                row.classList.add('expanded');
                // Could load detailed strategy comparison here via another API call
            }
        }

        function formatTime(date) {
            const minutes = Math.floor((new Date() - date) / 60000);
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Auto-refresh every 2 minutes
        setInterval(() => {
            loadDashboard();
        }, 120000);

        // Update "time ago" every 30 seconds
        setInterval(() => {
            if (lastUpdate) {
                document.getElementById('lastUpdated').textContent = `Last updated: ${formatTime(lastUpdate)}`;
            }
        }, 30000);

        // Initial load
        loadDashboard();
    </script>
</body>
</html>
